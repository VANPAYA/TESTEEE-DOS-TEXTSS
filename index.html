<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>日本語テキストラボ — N5 / N4</title>

  <style>
    :root{
      --bg0:#F6F8FF;
      --bg1:#EEF3FF;
      --card: rgba(255,255,255,.82);
      --card2: rgba(255,255,255,.72);
      --stroke: rgba(15,25,45,.12);
      --stroke2: rgba(15,25,45,.10);
      --text:#0E1630;
      --muted: rgba(14,22,48,.70);
      --muted2: rgba(14,22,48,.52);

      --hue: 210;
      --a1: hsl(calc(var(--hue) + 10) 90% 45%);
      --a2: hsl(calc(var(--hue) - 20) 92% 44%);
      --a3: hsl(calc(var(--hue) + 55) 88% 48%);

      --shadow: 0 18px 55px rgba(12,18,40,.12);
      --shadow2: 0 10px 30px rgba(12,18,40,.10);

      --radius: 18px;
      --radius2: 26px;

      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Liberation Sans", sans-serif;
      --jp: "Noto Sans JP", "Hiragino Kaku Gothic ProN", "Yu Gothic", "Meiryo", var(--sans);

      --fontScale: 1;
    }

    body.theme-dark{
      --bg0:#070A10;
      --bg1:#0B1220;
      --card: rgba(255,255,255,.06);
      --card2: rgba(255,255,255,.045);
      --stroke: rgba(255,255,255,.14);
      --stroke2: rgba(255,255,255,.12);
      --text:#EAF0FF;
      --muted: rgba(234,240,255,.72);
      --muted2: rgba(234,240,255,.55);

      --shadow: 0 18px 55px rgba(0,0,0,.45);
      --shadow2: 0 12px 34px rgba(0,0,0,.38);
    }

    *{box-sizing:border-box}
    html,body{height:100%}

    body{
      margin:0;
      font-family: var(--sans);
      color: var(--text);
      background:
        radial-gradient(1200px 700px at 15% 10%, rgba(50,120,255,.16), transparent 55%),
        radial-gradient(900px 600px at 90% 25%, rgba(255,80,220,.10), transparent 58%),
        radial-gradient(900px 600px at 50% 92%, rgba(0,200,140,.09), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow:hidden;
      -webkit-text-size-adjust: 100%;
      text-rendering: optimizeLegibility;
    }

    .aurora{
      position:fixed; inset:-20%;
      background:
        radial-gradient(closest-side at 20% 20%, rgba(255,255,255,.30), transparent 62%),
        radial-gradient(closest-side at 80% 30%, rgba(255,255,255,.22), transparent 62%),
        radial-gradient(closest-side at 50% 80%, rgba(255,255,255,.20), transparent 62%),
        conic-gradient(from 230deg at 50% 50%,
          rgba(0,0,0,0),
          rgba(0,0,0,0),
          rgba(255,255,255,.18),
          rgba(0,0,0,0),
          rgba(255,255,255,.14),
          rgba(0,0,0,0)
        );
      filter: blur(40px) saturate(110%);
      opacity:.50;
      animation: drift 18s ease-in-out infinite;
      pointer-events:none;
      z-index: 0;
    }
    body.theme-dark .aurora{ opacity:.58; filter: blur(34px) saturate(120%); }

    /* LUZES AO REDOR DO SITE (borda luminosa animada) */
    .edgeLights{
      position:fixed; inset:0;
      pointer-events:none;
      z-index: 1;
      opacity: .95;
      background:
        /* topo */
        linear-gradient(180deg, rgba(255,255,255,.0), rgba(255,255,255,.0)),
        linear-gradient(90deg,
          rgba(0,0,0,0) 0%,
          hsla(calc(var(--hue) + 40) 92% 58% / .18) 18%,
          hsla(calc(var(--hue) - 10) 92% 56% / .22) 50%,
          hsla(calc(var(--hue) + 90) 92% 58% / .18) 82%,
          rgba(0,0,0,0) 100%
        );
      mask-image:
        radial-gradient(120px 120px at 0% 0%, rgba(0,0,0,.0), rgba(0,0,0,1) 55%),
        radial-gradient(120px 120px at 100% 0%, rgba(0,0,0,.0), rgba(0,0,0,1) 55%),
        radial-gradient(120px 120px at 0% 100%, rgba(0,0,0,.0), rgba(0,0,0,1) 55%),
        radial-gradient(120px 120px at 100% 100%, rgba(0,0,0,.0), rgba(0,0,0,1) 55%),
        linear-gradient(#000,#000);
      filter: blur(18px) saturate(140%);
      mix-blend-mode: screen;
      animation: edgePulse 6.8s ease-in-out infinite;
    }
    body.theme-dark .edgeLights{
      opacity: 1;
      filter: blur(14px) saturate(160%);
      mix-blend-mode: lighten;
    }

    /* Luzes nas bordas (layer extra via pseudo) */
    .edgeLights::before{
      content:"";
      position:absolute; inset: 10px;
      border-radius: 28px;
      background:
        linear-gradient(90deg,
          hsla(calc(var(--hue) + 20) 95% 60% / .22),
          hsla(calc(var(--hue) - 30) 95% 58% / .22),
          hsla(calc(var(--hue) + 80) 95% 60% / .22)
        );
      filter: blur(28px);
      opacity: .8;
      animation: edgeDrift 9.5s ease-in-out infinite;
    }

    .edgeLights::after{
      content:"";
      position:absolute; inset: 0;
      background:
        radial-gradient(500px 180px at 50% 0%, hsla(calc(var(--hue) + 20) 95% 62% / .14), transparent 70%),
        radial-gradient(520px 200px at 50% 100%, hsla(calc(var(--hue) - 30) 95% 62% / .12), transparent 72%),
        radial-gradient(220px 520px at 0% 50%, hsla(calc(var(--hue) + 85) 95% 62% / .10), transparent 72%),
        radial-gradient(220px 520px at 100% 50%, hsla(calc(var(--hue) + 5) 95% 62% / .10), transparent 72%);
      filter: blur(10px);
      opacity: .8;
      animation: edgePulse 7.4s ease-in-out infinite reverse;
    }

    @keyframes edgePulse{
      0%{ transform: translate3d(0,0,0) scale(1); opacity:.88; }
      50%{ transform: translate3d(0,0,0) scale(1.02); opacity:1; }
      100%{ transform: translate3d(0,0,0) scale(1); opacity:.88; }
    }
    @keyframes edgeDrift{
      0%{ transform: translate3d(-1.2%, -0.6%, 0) rotate(-1deg); }
      50%{ transform: translate3d(1.2%, 0.8%, 0) rotate(1deg); }
      100%{ transform: translate3d(-1.2%, -0.6%, 0) rotate(-1deg); }
    }

    @keyframes drift{
      0%   { transform: translate3d(-2%, -1%, 0) scale(1.02) rotate(0deg); }
      50%  { transform: translate3d(2%,  2%, 0) scale(1.06) rotate(8deg); }
      100% { transform: translate3d(-2%, -1%, 0) scale(1.02) rotate(0deg); }
    }

    .app{
      position:relative;
      z-index: 2; /* acima das luzes */
      height: 100%;
      min-height: 100dvh;
      display:grid;
      grid-template-columns: minmax(270px, 360px) minmax(0, 1fr);
      gap: 14px;
      padding: 14px;
    }

    .panel{
      background: linear-gradient(180deg, var(--card), var(--card2));
      border: 1px solid var(--stroke);
      border-radius: var(--radius2);
      box-shadow: var(--shadow);
      overflow:hidden;
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      display:flex;
      flex-direction:column;
      min-height: 0;
      position:relative;
    }

    /* brilho sutil em volta de cada painel */
    .panel::before{
      content:"";
      position:absolute; inset:-1px;
      border-radius: inherit;
      pointer-events:none;
      background:
        radial-gradient(260px 160px at 18% 0%, hsla(calc(var(--hue) + 20) 92% 60% / .16), transparent 70%),
        radial-gradient(260px 160px at 82% 100%, hsla(calc(var(--hue) - 25) 92% 60% / .12), transparent 70%);
      opacity:.85;
      filter: blur(10px);
    }

    .panelHeader{
      padding: 16px 16px 12px;
      border-bottom: 1px solid var(--stroke2);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      flex-wrap:wrap;
      position:relative;
      z-index: 1;
    }

    .brand{
      display:flex;
      gap: 12px;
      align-items:center;
      min-width: 0;
    }
    .logo{
      width: 44px; height: 44px;
      border-radius: 14px;
      background:
        radial-gradient(80% 80% at 20% 20%, rgba(255,255,255,.35), transparent 60%),
        linear-gradient(135deg, rgba(255,255,255,.26), rgba(255,255,255,.10));
      border: 1px solid var(--stroke);
      position:relative;
      overflow:hidden;
      flex: 0 0 auto;
      box-shadow: var(--shadow2);
    }
    body.theme-dark .logo{
      background:
        radial-gradient(80% 80% at 20% 20%, rgba(255,255,255,.22), transparent 60%),
        linear-gradient(135deg, rgba(255,255,255,.16), rgba(255,255,255,.04));
    }
    .logo::after{
      content:"";
      position:absolute; inset:-40%;
      background: conic-gradient(from 180deg,
        rgba(255,255,255,0),
        rgba(255,255,255,.35),
        rgba(255,255,255,0));
      transform: rotate(12deg);
      animation: sheen 3.8s ease-in-out infinite;
      opacity:.85;
      pointer-events:none;
    }
    @keyframes sheen{
      0%{ transform: translateX(-18%) rotate(12deg); }
      55%{ transform: translateX(18%) rotate(12deg); }
      100%{ transform: translateX(-18%) rotate(12deg); }
    }

    .brandTitle{ display:flex; flex-direction:column; gap: 2px; min-width: 0; }
    .brandTitle .name{
      font-weight: 1000;
      letter-spacing: .2px;
      font-size: 14px;
      line-height: 1.1;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .brandTitle .sub{
      font-size: 12px;
      color: var(--muted);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .content{
      padding: 14px 14px 16px;
      overflow:auto;
      min-height: 0;
      overscroll-behavior: contain;
      -webkit-overflow-scrolling: touch;
      position:relative;
      z-index:1;
    }

    .row{ display:flex; gap: 10px; align-items:center; flex-wrap:wrap; }
    .col{ display:flex; flex-direction:column; gap: 10px; }

    /* RESPONSIVO */
    @media (max-width: 980px){
      body{ overflow:auto; }
      .app{
        grid-template-columns: 1fr;
        height:auto;
        min-height: 100dvh;
        overflow:visible;
      }
      .panel{ min-height: unset; }
      .content{ max-height: none; }
    }

    @media (max-width: 520px){
      .app{ padding: 10px; gap: 10px; }
      .panelHeader{ padding: 12px 12px 10px; }
      .content{ padding: 12px; }
      .logo{ width: 40px; height: 40px; border-radius: 13px; }
      .brandTitle .name{ font-size: 13px; }
      .brandTitle .sub{ font-size: 11px; }
    }

    .input, .select, .textarea{
      width: 100%;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,.70);
      color: var(--text);
      border-radius: 14px;
      padding: 11px 12px;
      outline: none;
      font-size: 13px;
      box-shadow: 0 6px 18px rgba(12,18,40,.06);
    }
    body.theme-dark .input,
    body.theme-dark .select,
    body.theme-dark .textarea{
      background: rgba(0,0,0,.18);
      box-shadow: none;
    }
    .textarea{ min-height: 120px; resize: vertical; font-family: var(--mono); }
    .input::placeholder,.textarea::placeholder{ color: rgba(14,22,48,.45); }
    body.theme-dark .input::placeholder,
    body.theme-dark .textarea::placeholder{ color: rgba(234,240,255,.40); }

    .btn{
      cursor:pointer;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,.62);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 14px;
      font-weight: 900;
      font-size: 12px;
      transition: transform .12s ease, background .12s ease, border-color .12s ease;
      display:inline-flex;
      align-items:center;
      gap: 8px;
      user-select:none;
      box-shadow: 0 8px 20px rgba(12,18,40,.08);
      touch-action: manipulation;
    }
    body.theme-dark .btn{
      background: rgba(255,255,255,.06);
      box-shadow: none;
    }
    .btn:hover{ transform: translateY(-1px); background: rgba(255,255,255,.78); border-color: rgba(15,25,45,.18); }
    body.theme-dark .btn:hover{ background: rgba(255,255,255,.085); border-color: rgba(255,255,255,.20); }
    .btn:active{ transform: translateY(0px); }

    .btnPrimary{
      background: linear-gradient(135deg, rgba(0,0,0,.06), rgba(255,255,255,.76));
      border-color: rgba(15,25,45,.18);
      position:relative;
      overflow:hidden;
    }
    body.theme-dark .btnPrimary{
      background: linear-gradient(135deg, rgba(255,255,255,.12), rgba(255,255,255,.06));
      border-color: rgba(255,255,255,.20);
    }

    .segmented{
      display:flex;
      gap: 8px;
      padding: 8px;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,.62);
      border-radius: 999px;
      width: 100%;
      box-shadow: 0 10px 26px rgba(12,18,40,.08);
    }
    body.theme-dark .segmented{ background: rgba(255,255,255,.04); box-shadow:none; }

    .segBtn{
      flex:1;
      text-align:center;
      padding: 11px 10px;
      border-radius: 999px;
      cursor:pointer;
      border: 1px solid transparent;
      color: var(--muted);
      font-weight: 1000;
      font-size: 12px;
      user-select:none;
      background: transparent;
      touch-action: manipulation;
    }
    .segBtn.active{
      color: var(--text);
      border-color: rgba(15,25,45,.16);
      background: rgba(255,255,255,.84);
    }
    body.theme-dark .segBtn.active{
      border-color: rgba(255,255,255,.18);
      background: rgba(255,255,255,.06);
    }

    .tag{
      display:inline-flex;
      align-items:center;
      padding: 6px 10px;
      border: 1px solid var(--stroke);
      border-radius: 999px;
      background: rgba(255,255,255,.68);
      color: var(--muted);
      font-size: 12px;
      gap: 6px;
      white-space:nowrap;
    }
    body.theme-dark .tag{ background: rgba(255,255,255,.05); }
    .tag b{ color: var(--text); }

    .kpi{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
    }
    @media (max-width: 520px){
      .kpi{ grid-template-columns: 1fr; }
    }

    .kpiCard{
      padding: 12px;
      border-radius: 18px;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,.70);
      box-shadow: 0 10px 26px rgba(12,18,40,.08);
    }
    body.theme-dark .kpiCard{ background: rgba(255,255,255,.05); box-shadow:none; }
    .kpiCard .v{ font-weight: 1000; font-size: 16px; letter-spacing: .2px; }
    .kpiCard .l{ font-size: 12px; color: var(--muted); margin-top: 4px; }

    .list{ display:flex; flex-direction:column; gap: 10px; }
    .item{
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,.70);
      border-radius: 18px;
      padding: 12px;
      cursor:pointer;
      transition: transform .12s ease, background .12s ease, border-color .12s ease;
      box-shadow: 0 10px 26px rgba(12,18,40,.08);
      touch-action: manipulation;
    }
    body.theme-dark .item{ background: rgba(255,255,255,.04); box-shadow:none; }
    .item:hover{ transform: translateY(-1px); background: rgba(255,255,255,.86); border-color: rgba(15,25,45,.18); }
    body.theme-dark .item:hover{ background: rgba(255,255,255,.06); border-color: rgba(255,255,255,.18); }
    .item.active{
      border-color: rgba(15,25,45,.20);
      background: linear-gradient(135deg, rgba(255,255,255,.92), rgba(255,255,255,.70));
      box-shadow: 0 16px 40px rgba(12,18,40,.12);
    }
    body.theme-dark .item.active{
      border-color: rgba(255,255,255,.22);
      background: linear-gradient(135deg, rgba(255,255,255,.09), rgba(255,255,255,.04));
      box-shadow: 0 14px 40px rgba(0,0,0,.35);
    }
    .itemTop{ display:flex; justify-content:space-between; align-items:flex-start; gap: 10px; }
    .itemTitle{ font-weight: 1000; font-size: 13px; line-height: 1.25; margin:0; }
    .itemDesc{ margin: 6px 0 0; font-size: 12px; color: var(--muted); line-height: 1.35; }

    .mainHeader{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 12px;
      flex-wrap:wrap;
      width:100%;
    }
    .hTitle{ display:flex; flex-direction:column; gap: 6px; min-width: 240px; }
    .hTitle h1{ margin:0; font-size: 18px; letter-spacing:.2px; }
    .hTitle .meta{ display:flex; gap: 8px; flex-wrap:wrap; align-items:center; }

    .tabs{
      display:flex;
      gap: 8px;
      padding: 10px 12px;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,.62);
      border-radius: 999px;
      flex-wrap:nowrap;
      overflow:auto;
      -webkit-overflow-scrolling: touch;
      box-shadow: 0 10px 26px rgba(12,18,40,.08);
      max-width: min(560px, 100%);
    }
    .tabs::-webkit-scrollbar{ height: 0; }
    body.theme-dark .tabs{ background: rgba(255,255,255,.04); box-shadow:none; }

    .tab{
      padding: 9px 10px;
      border-radius: 999px;
      cursor:pointer;
      border: 1px solid transparent;
      color: var(--muted);
      font-weight: 1000;
      font-size: 12px;
      user-select:none;
      white-space: nowrap;
      touch-action: manipulation;
    }
    .tab.active{
      color: var(--text);
      border-color: rgba(15,25,45,.16);
      background: rgba(255,255,255,.86);
    }
    body.theme-dark .tab.active{
      border-color: rgba(255,255,255,.18);
      background: rgba(255,255,255,.06);
    }

    .lineList{ display:flex; flex-direction:column; gap: 12px; margin-top: 12px; }
    .lineCard{
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,.72);
      border-radius: 20px;
      padding: 14px;
      overflow:hidden;
      box-shadow: 0 12px 30px rgba(12,18,40,.08);
    }
    body.theme-dark .lineCard{ background: rgba(255,255,255,.04); box-shadow:none; }

    .lineTop{ display:flex; justify-content:space-between; align-items:flex-start; gap: 10px; }
    .lineLeft{ min-width: 0; }

    .jp{
      font-family: var(--jp);
      font-size: calc(17px * var(--fontScale));
      font-weight: 1000;
      line-height: 1.62;
      margin:0;
      word-break: break-word;
    }

    .reading{
      margin-top: 8px;
      font-size: calc(13px * var(--fontScale));
      color: var(--muted);
      font-family: var(--jp);
      line-height: 1.45;
      word-break: break-word;
    }

    .lineBadges{ display:flex; flex-direction:column; gap: 8px; align-items:flex-end; }

    @media (max-width: 520px){
      .lineTop{ flex-direction:column; align-items:stretch; }
      .lineBadges{ flex-direction:row; justify-content:flex-start; flex-wrap:wrap; align-items:center; }
    }

    .chk{
      display:flex; align-items:center; gap: 8px;
      padding: 7px 10px;
      border-radius: 999px;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,.70);
      font-size: 12px;
      color: var(--muted);
      user-select:none;
      box-shadow: 0 8px 18px rgba(12,18,40,.06);
    }
    body.theme-dark .chk{ background: rgba(0,0,0,.20); box-shadow:none; }
    .chk input{ accent-color: var(--a1); }

    .details{
      margin-top: 12px;
      border-top: 1px dashed var(--stroke);
      padding-top: 12px;
      display:none;
    }
    .lineCard.open .details{ display:block; }

    .notes{
      margin-top: 6px;
      display:grid;
      grid-template-columns: 1fr;
      gap: 10px;
    }
    .box{
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,.78);
      border-radius: 16px;
      padding: 12px;
      box-shadow: 0 10px 26px rgba(12,18,40,.06);
    }
    body.theme-dark .box{ background: rgba(0,0,0,.18); box-shadow:none; }

    .boxTitle{
      display:flex; justify-content:space-between; align-items:center; gap: 10px;
      margin-bottom: 8px;
    }
    .boxTitle b{
      font-size: 12px;
      color: var(--muted);
      letter-spacing:.18px;
      text-transform: uppercase;
    }
    .box p{
      margin: 0;
      font-size: calc(13.6px * var(--fontScale));
      color: var(--text);
      line-height: 1.62;
      word-break: break-word;
    }

    .hr{ border:0; border-top: 1px solid var(--stroke2); margin: 12px 0; }
    .muted{ color: var(--muted); }

    .vocabGrid{
      display:grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin-top: 12px;
    }
    @media (max-width: 980px){ .vocabGrid{ grid-template-columns: 1fr; } }

    .vocabCard{
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,.74);
      border-radius: 20px;
      padding: 14px;
      display:flex;
      justify-content:space-between;
      gap: 10px;
      box-shadow: 0 12px 30px rgba(12,18,40,.08);
    }
    body.theme-dark .vocabCard{ background: rgba(255,255,255,.04); box-shadow:none; }

    .vocabCard .w{
      font-family: var(--jp);
      font-size: calc(20px * var(--fontScale));
      font-weight: 1000;
      margin:0;
      line-height: 1.25;
    }
    .vocabCard .r{
      margin-top: 6px;
      color: var(--muted);
      font-size: calc(14px * var(--fontScale));
      font-family: var(--jp);
      line-height: 1.35;
    }
    .vocabCard .m{
      margin-top: 8px;
      color: var(--text);
      font-size: calc(14px * var(--fontScale));
      line-height: 1.45;
    }
    .vocabRight{ display:flex; flex-direction:column; gap: 8px; align-items:flex-end; justify-content:space-between; min-width: 140px; }

    .cardWrap{ margin-top: 12px; display:grid; grid-template-columns: 1.2fr .8fr; gap: 12px; }
    @media (max-width: 980px){ .cardWrap{ grid-template-columns: 1fr; } }

    .flash{
      border: 1px solid var(--stroke);
      background: radial-gradient(120% 120% at 20% 10%, rgba(255,255,255,.85), rgba(255,255,255,.62));
      border-radius: 24px;
      padding: 18px;
      min-height: 240px;
      display:flex;
      flex-direction:column;
      justify-content:center;
      align-items:center;
      gap: 10px;
      text-align:center;
      box-shadow: 0 18px 55px rgba(12,18,40,.10);
      position:relative;
      overflow:hidden;
    }
    body.theme-dark .flash{
      background: radial-gradient(120% 120% at 20% 10%, rgba(255,255,255,.08), rgba(255,255,255,.03));
      box-shadow: 0 18px 55px rgba(0,0,0,.35);
    }
    .flash .front{ font-family: var(--jp); font-size: calc(34px * var(--fontScale)); font-weight: 1000; letter-spacing:.3px; }
    .flash .back{ display:none; width: 100%; max-width: 560px; }
    .flash.revealed .back{ display:block; }
    .flash.revealed .hint{ display:none; }
    .flash .hint{ color: var(--muted); font-size: 12px; margin-top: 6px; }
    .flash .subline{ margin-top: 6px; color: var(--muted); font-size: calc(14px * var(--fontScale)); font-family: var(--jp); }
    .flash .meaning{ margin-top: 10px; color: var(--text); font-size: calc(15px * var(--fontScale)); line-height: 1.5; }

    .quizQ{ margin-top: 12px; border: 1px solid var(--stroke); background: rgba(255,255,255,.74); border-radius: 20px; padding: 14px; box-shadow: 0 12px 30px rgba(12,18,40,.08); }
    body.theme-dark .quizQ{ background: rgba(255,255,255,.04); box-shadow:none; }
    .quizQ h3{ margin:0 0 10px; font-size: 14px; line-height: 1.35; }
    .choices{ display:flex; flex-direction:column; gap: 9px; }
    .choice{
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,.70);
      border-radius: 16px;
      padding: 12px 12px;
      cursor:pointer;
      transition: transform .12s ease, background .12s ease, border-color .12s ease;
      user-select:none;
      display:flex; justify-content:space-between; gap: 10px;
      box-shadow: 0 10px 24px rgba(12,18,40,.06);
      touch-action: manipulation;
    }
    body.theme-dark .choice{ background: rgba(0,0,0,.18); box-shadow:none; }
    .choice:hover{ transform: translateY(-1px); background: rgba(255,255,255,.86); border-color: rgba(15,25,45,.18); }
    body.theme-dark .choice:hover{ background: rgba(255,255,255,.06); border-color: rgba(255,255,255,.20); }
    .choice.good{ border-color: rgba(0,190,120,.35); background: rgba(0,190,120,.10); }
    .choice.bad{ border-color: rgba(255,80,120,.35); background: rgba(255,80,120,.10); }
    .choice small{ color: var(--muted); }

    .focus{
      position:fixed; inset:0;
      background:
        radial-gradient(1200px 700px at 20% 20%, rgba(50,120,255,.14), transparent 58%),
        radial-gradient(900px 600px at 85% 30%, rgba(255,80,220,.10), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      z-index: 60;
      display:none;
      padding: 14px;
      overflow:auto;
      -webkit-overflow-scrolling: touch;
    }
    .focus.open{ display:block; }

    .ic{ width: 14px; height: 14px; display:inline-block; }
    .ic svg{ width:100%; height:100%; fill: currentColor; opacity:.9; }

    ruby{
      ruby-position: over;
      ruby-align: center;
      font-variant-east-asian: ruby;
      line-height: 1.6;
    }
    rt{
      font-size: 0.58em;
      color: rgba(14,22,48,.70);
      font-weight: 900;
      letter-spacing: .2px;
    }
    body.theme-dark rt{ color: rgba(234,240,255,.78); }
  </style>
</head>

<body>
  <div class="aurora"></div>
  <div class="edgeLights"></div>

  <div class="app" id="app">
    <!-- LEFT -->
    <section class="panel" id="leftPanel" aria-label="Biblioteca">
      <div class="panelHeader">
        <div class="brand">
          <div class="logo" aria-hidden="true"></div>
          <div class="brandTitle">
            <div class="name">日本語テキストラボ</div>
            <div class="sub">N5 / N4</div>
          </div>
        </div>
        <div class="row">
          <button class="btn" id="btnTheme">Aparência: Claro</button>
        </div>
      </div>

      <div class="content">
        <div class="col">
          <div class="segmented" aria-label="Nível">
            <button class="segBtn active" id="segN5" type="button">N5</button>
            <button class="segBtn" id="segN4" type="button">N4</button>
          </div>

          <input class="input" id="searchInput" placeholder="Buscar título / JP / palavra-chave..." />

          <div class="kpi" aria-label="Resumo">
            <div class="kpiCard">
              <div class="v" id="kpiTexts">0</div>
              <div class="l">Textos</div>
            </div>
            <div class="kpiCard">
              <div class="v" id="kpiLinesDone">0</div>
              <div class="l">Revisadas</div>
            </div>
            <div class="kpiCard">
              <div class="v" id="kpiDeck">0</div>
              <div class="l">Deck</div>
            </div>
          </div>

          <div class="row">
            <button class="btn" id="btnReset">
              <span class="ic" aria-hidden="true">
                <svg viewBox="0 0 24 24"><path d="M12 6V3L8 7l4 4V8c2.76 0 5 2.24 5 5a5 5 0 1 1-9.9-1h-2.02A7 7 0 1 0 12 6z"/></svg>
              </span>
              Reset progresso
            </button>
          </div>

          <div class="hr"></div>

          <div class="list" id="libraryList"></div>
        </div>
      </div>
    </section>

    <!-- RIGHT -->
    <section class="panel" aria-label="Leitor">
      <div class="panelHeader">
        <div class="mainHeader">
          <div class="hTitle">
            <h1 id="textTitle">Selecione um texto</h1>
            <div class="meta" id="textMeta"></div>
          </div>

          <div class="row">
            <div class="tabs" role="tablist" aria-label="Abas">
              <div class="tab active" data-tab="TAB_TEXT" role="tab">Texto</div>
              <div class="tab" data-tab="TAB_VOCAB" role="tab">Vocabulário</div>
              <div class="tab" data-tab="TAB_FLASH" role="tab">Deck</div>
              <div class="tab" data-tab="TAB_QUIZ" role="tab">Quiz</div>
              <div class="tab" data-tab="TAB_NOTES" role="tab">Notas</div>
            </div>

            <button class="btn btnPrimary" id="btnFocus">
              <span class="ic" aria-hidden="true">
                <svg viewBox="0 0 24 24"><path d="M7 14H5v5h5v-2H7v-3zm0-4h2V7h3V5H5v5zm10 9h-3v2h5v-5h-2v3zm0-14V5h-5v2h3v3h2z"/></svg>
              </span>
              Modo foco
            </button>
          </div>
        </div>
      </div>

      <div class="content" id="mainContent">
        <div id="emptyState" style="opacity:.98">
          <div class="box">
            <div class="boxTitle">
              <b>Controles</b>
              <span class="tag">Estudo</span>
            </div>
            <p>
              Use os botões para se testar: desligue tradução/leitura e confirme mentalmente antes de abrir detalhes.
            </p>
          </div>

          <div class="row" style="margin-top:10px">
            <button class="btn" id="btnToggleFuri">Furigana: ON</button>
            <button class="btn" id="btnToggleReading">Leitura: ON</button>
            <button class="btn" id="btnTogglePT">Tradução: ON</button>
            <button class="btn" id="btnFontMinus">A-</button>
            <button class="btn" id="btnFontPlus">A+</button>
          </div>
        </div>

        <div id="tab_TEXT" style="display:none">
          <div class="row" style="justify-content:space-between;align-items:center">
            <div class="row">
              <button class="btn" id="btnToggleFuri2">Furigana: ON</button>
              <button class="btn" id="btnToggleReading2">Leitura: ON</button>
              <button class="btn" id="btnTogglePT2">Tradução: ON</button>
              <button class="btn" id="btnExpandAll">Abrir tudo</button>
              <button class="btn" id="btnCollapseAll">Fechar tudo</button>
            </div>
            <div class="row">
              <button class="btn" id="btnFontMinus2">A-</button>
              <button class="btn" id="btnFontPlus2">A+</button>
              <button class="btn" id="btnBookmark">☆ Favoritar</button>
            </div>
          </div>

          <div class="lineList" id="lineList"></div>
        </div>

        <div id="tab_VOCAB" style="display:none">
          <div class="box">
            <div class="boxTitle">
              <b>Vocabulário do texto</b>
              <span class="tag">Verbos: tipo</span>
            </div>
            <p>Quando for verbo, o site indica em PT-BR se é <b>verbo transitivo</b> ou <b>verbo intransitivo</b>.</p>
          </div>
          <div class="vocabGrid" id="vocabGrid"></div>
        </div>

        <div id="tab_FLASH" style="display:none">
          <div class="box">
            <div class="boxTitle">
              <b>Deck</b>
              <span class="tag">repetição</span>
            </div>
            <p>Revele a resposta e marque sua confiança (1/2/3). O site agenda automaticamente.</p>
          </div>

          <div class="cardWrap">
            <div class="flash" id="flashCard">
              <div class="front" id="flashFront">—</div>
              <div class="hint" id="flashHint">Clique em “Revelar”</div>
              <div class="back" id="flashBack">
                <div class="subline" id="flashReading">—</div>
                <div class="meaning" id="flashMeaning">—</div>
              </div>
            </div>

            <div class="col">
              <div class="row">
                <button class="btn btnPrimary" id="btnReveal">Revelar</button>
                <button class="btn" id="btnNext">Próximo</button>
              </div>
              <div class="row">
                <button class="btn" id="btnRate1">1 • Difícil</button>
                <button class="btn" id="btnRate2">2 • Ok</button>
                <button class="btn" id="btnRate3">3 • Fácil</button>
              </div>

              <div class="box">
                <div class="boxTitle"><b>Status</b></div>
                <p id="deckStatus" class="muted" style="font-size:12px;line-height:1.55">Adicione cards na aba Vocabulário.</p>
              </div>

              <div class="row">
                <button class="btn" id="btnClearDeck">Limpar deck</button>
              </div>
            </div>
          </div>
        </div>

        <div id="tab_QUIZ" style="display:none">
          <div class="box">
            <div class="boxTitle">
              <b>Quiz</b>
              <span class="tag">fechamento</span>
            </div>
            <p>Gere perguntas a partir do vocabulário do texto (ou do seu deck).</p>
            <div class="row">
              <button class="btn btnPrimary" id="btnNewQuiz">Gerar quiz</button>
              <select class="select" id="quizSource" style="max-width:260px">
                <option value="TEXT">Fonte: Vocabulário do texto</option>
                <option value="DECK">Fonte: Meu deck</option>
              </select>
              <select class="select" id="quizCount" style="max-width:200px">
                <option value="5">5 questões</option>
                <option value="8" selected>8 questões</option>
                <option value="12">12 questões</option>
              </select>
            </div>
          </div>

          <div id="quizWrap"></div>
        </div>

        <div id="tab_NOTES" style="display:none">
          <div class="box">
            <div class="boxTitle">
              <b>Notas</b>
              <span class="tag">auto-save</span>
            </div>
            <p>Guarde padrões, frases úteis e observações rápidas.</p>
            <textarea class="textarea" id="textNotes" placeholder="Ex.: 〜ことになった / 〜ておく / 〜ように / etc."></textarea>
            <div class="row" style="justify-content:space-between;align-items:center">
              <div class="muted" style="font-size:12px">Salvo automaticamente</div>
              <button class="btn" id="btnClearNotes">Limpar notas</button>
            </div>
          </div>
        </div>

      </div>
    </section>
  </div>

  <!-- Focus overlay -->
  <div class="focus" id="focusOverlay">
    <section class="panel" style="height:100%">
      <div class="panelHeader">
        <div class="row">
          <button class="btn btnPrimary" id="btnExitFocus">
            <span class="ic" aria-hidden="true">
              <svg viewBox="0 0 24 24"><path d="M18.3 5.71 12 12l6.3 6.29-1.41 1.42L12 14.83l-6.89 6.88-1.41-1.42L10.59 12 3.7 5.71 5.11 4.29 12 11.17l6.89-6.88z"/></svg>
            </span>
            Sair
          </button>
          <div class="tag">Modo foco</div>
        </div>
        <div class="row">
          <button class="btn" id="btnToggleFuriFocus">Furigana: ON</button>
          <button class="btn" id="btnToggleReadingFocus">Leitura: ON</button>
          <button class="btn" id="btnTogglePTFocus">Tradução: ON</button>
          <button class="btn" id="btnFontMinusFocus">A-</button>
          <button class="btn" id="btnFontPlusFocus">A+</button>
        </div>
      </div>
      <div class="content">
        <div class="lineList" id="focusLineList"></div>
      </div>
    </section>
  </div>

  <script>
    /***********************
     * TEXTOS
     ***********************/
    const builtInTexts = [
      /* =========================
         N5 (já existentes)
      ========================== */
      {
        id: "n5_school_day",
        level: "N5",
        title: "学校の一日",
        desc: "rotina / horas / sequência て-form",
        tags: ["学校","日常"],
        lines: [
          {
            jp: "私は毎朝六時に起きます。",
            jpRuby: "私<ruby>は<rt></rt></ruby>毎朝<ruby>六時<rt>ろくじ</rt></ruby>に<ruby>起<rt>お</rt></ruby>きます。",
            reading: "わたしは まいあさ ろくじに おきます。",
            pt: "Eu acordo às seis da manhã todos os dias.",
            structure: "私は + (tempo) + (hora) に + 起きます",
            literal: "Quanto a mim, (toda manhã) (às seis) eu acordo.",
            points: [
              "は marca tópico.",
              "に marca horário específico.",
              "起きる é geralmente verbo intransitivo (a ação acontece com o sujeito)."
            ],
            grammar: "Aは + tempo + horaに + Vます",
            breakdown: [
              { jp:"私", r:"わたし", m:"eu", note:"pronome" },
              { jp:"は", r:"は", m:"tópico", note:"partícula" },
              { jp:"毎朝", r:"まいあさ", m:"todas as manhãs", note:"tempo" },
              { jp:"六時", r:"ろくじ", m:"seis horas", note:"hora" },
              { jp:"に", r:"に", m:"às (hora)", note:"partícula" },
              { jp:"起きます", r:"おきます", m:"acordo", note:"Vます", vt:"自" }
            ],
            vocab: [
              { w:"毎朝", r:"まいあさ", m:"todas as manhãs" },
              { w:"起きる", r:"おきる", m:"acordar", vt:"自" },
              { w:"六時", r:"ろくじ", m:"seis horas" }
            ]
          },
          {
            jp: "朝ご飯を食べて、シャワーを浴びます。",
            jpRuby: "<ruby>朝<rt>あさ</rt></ruby>ご<ruby>飯<rt>はん</rt></ruby>を<ruby>食<rt>た</rt></ruby>べて、シャワーを<ruby>浴<rt>あ</rt></ruby>びます。",
            reading: "あさごはんを たべて、しゃわーを あびます。",
            pt: "Eu como o café da manhã e tomo banho.",
            structure: "Aを 食べて、Bを 浴びます",
            literal: "(Café da manhã) eu como e (banho) eu tomo.",
            points: [
              "〜て liga ações em sequência.",
              "食べる é verbo transitivo (come algo).",
              "浴びる aqui funciona como verbo transitivo (シャワーを浴びる)."
            ],
            grammar: "Vて + Vます (sequência)",
            breakdown: [
              { jp:"朝ご飯", r:"あさごはん", m:"café da manhã", note:"substantivo" },
              { jp:"を", r:"を", m:"objeto", note:"partícula" },
              { jp:"食べて", r:"たべて", m:"comer (e...)", note:"Vて", vt:"他" },
              { jp:"シャワー", r:"しゃわー", m:"banho (chuveiro)", note:"katakana" },
              { jp:"を", r:"を", m:"objeto", note:"partícula" },
              { jp:"浴びます", r:"あびます", m:"tomo (banho)", note:"Vます", vt:"他" }
            ],
            vocab: [
              { w:"朝ご飯", r:"あさごはん", m:"café da manhã" },
              { w:"食べる", r:"たべる", m:"comer", vt:"他" },
              { w:"浴びる", r:"あびる", m:"tomar/receber (banho, sol)", vt:"他" }
            ]
          },
          {
            jp: "七時半に家を出ます。",
            jpRuby: "<ruby>七時半<rt>しちじはん</rt></ruby>に<ruby>家<rt>いえ</rt></ruby>を<ruby>出<rt>で</rt></ruby>ます。",
            reading: "しちじはんに いえを でます。",
            pt: "Eu saio de casa às 7:30.",
            structure: "(hora)に + (lugar)を + 出ます",
            literal: "Às sete e meia, saio de casa.",
            points: [
              "家を出る = sair de casa (を = ponto de saída).",
              "出る aqui funciona como verbo intransitivo (você sai)."
            ],
            grammar: "lugarを出る",
            breakdown: [
              { jp:"七時半", r:"しちじはん", m:"sete e meia", note:"hora" },
              { jp:"に", r:"に", m:"às (hora)", note:"partícula" },
              { jp:"家", r:"いえ", m:"casa", note:"substantivo" },
              { jp:"を", r:"を", m:"ponto de saída", note:"partícula" },
              { jp:"出ます", r:"でます", m:"saio", note:"Vます", vt:"自" }
            ],
            vocab: [
              { w:"七時半", r:"しちじはん", m:"sete e meia" },
              { w:"家", r:"いえ", m:"casa" },
              { w:"出る", r:"でる", m:"sair", vt:"自" }
            ]
          },
          {
            jp: "駅まで歩いて行きます。",
            jpRuby: "<ruby>駅<rt>えき</rt></ruby>まで<ruby>歩<rt>ある</rt></ruby>いて<ruby>行<rt>い</rt></ruby>きます。",
            reading: "えきまで あるいて いきます。",
            pt: "Eu vou a pé até a estação.",
            structure: "目的地まで + 歩いて + 行きます",
            literal: "Até a estação, indo a pé, vou.",
            points: [
              "まで = até (limite).",
              "歩く é verbo intransitivo (andar).",
              "行く é verbo intransitivo (ir)."
            ],
            grammar: "Vて + 行く (meio/ação)",
            breakdown: [
              { jp:"駅", r:"えき", m:"estação", note:"substantivo" },
              { jp:"まで", r:"まで", m:"até", note:"partícula" },
              { jp:"歩いて", r:"あるいて", m:"andando / a pé", note:"Vて", vt:"自" },
              { jp:"行きます", r:"いきます", m:"vou", note:"Vます", vt:"自" }
            ],
            vocab: [
              { w:"駅", r:"えき", m:"estação" },
              { w:"歩く", r:"あるく", m:"andar", vt:"自" },
              { w:"行く", r:"いく", m:"ir", vt:"自" }
            ]
          },
          {
            jp: "電車で学校に行きます。",
            jpRuby: "<ruby>電車<rt>でんしゃ</rt></ruby>で<ruby>学校<rt>がっこう</rt></ruby>に<ruby>行<rt>い</rt></ruby>きます。",
            reading: "でんしゃで がっこうに いきます。",
            pt: "Eu vou para a escola de trem.",
            structure: "乗り物で + 場所に + 行きます",
            literal: "De trem, para a escola, vou.",
            points: ["で = meio", "に = destino", "行く = verbo intransitivo"],
            grammar: "で (meio) + に (destino)",
            breakdown: [
              { jp:"電車", r:"でんしゃ", m:"trem", note:"meio" },
              { jp:"で", r:"で", m:"por / de (meio)", note:"partícula" },
              { jp:"学校", r:"がっこう", m:"escola", note:"destino" },
              { jp:"に", r:"に", m:"para (destino)", note:"partícula" },
              { jp:"行きます", r:"いきます", m:"vou", note:"Vます", vt:"自" }
            ],
            vocab: [
              { w:"電車", r:"でんしゃ", m:"trem" },
              { w:"学校", r:"がっこう", m:"escola" },
              { w:"行く", r:"いく", m:"ir", vt:"自" }
            ]
          }
        ]
      },

      {
        id: "n5_shopping",
        level: "N5",
        title: "買い物",
        desc: "ほしい / ください / いくら / ありますか",
        tags: ["店","買い物"],
        lines: [
          {
            jp: "今日はスーパーで野菜を買います。",
            jpRuby: "<ruby>今日<rt>きょう</rt></ruby>はスーパーで<ruby>野菜<rt>やさい</rt></ruby>を<ruby>買<rt>か</rt></ruby>います。",
            reading: "きょうは すーぱーで やさいを かいます。",
            pt: "Hoje eu compro legumes no supermercado.",
            structure: "今日は + 場所で + Nを + 買います",
            literal: "Quanto a hoje, no supermercado, legumes eu compro.",
            points: ["で = local da ação", "買う = verbo transitivo (compra algo)."],
            grammar: "場所で + Nを + Vます",
            breakdown: [
              { jp:"今日", r:"きょう", m:"hoje", note:"tempo" },
              { jp:"は", r:"は", m:"tópico", note:"partícula" },
              { jp:"スーパー", r:"すーぱー", m:"supermercado", note:"local" },
              { jp:"で", r:"で", m:"em (local da ação)", note:"partícula" },
              { jp:"野菜", r:"やさい", m:"legumes/verduras", note:"objeto" },
              { jp:"を", r:"を", m:"objeto", note:"partícula" },
              { jp:"買います", r:"かいます", m:"compro", note:"Vます", vt:"他" }
            ],
            vocab: [
              { w:"野菜", r:"やさい", m:"legumes/verduras" },
              { w:"買う", r:"かう", m:"comprar", vt:"他" },
              { w:"スーパー", r:"すーぱー", m:"supermercado" }
            ]
          },
          {
            jp: "トマトを三つください。",
            jpRuby: "トマトを<ruby>三<rt>みっ</rt></ruby>つください。",
            reading: "とまとを みっつ ください。",
            pt: "Por favor, me dê três tomates.",
            structure: "Nを + 数 + ください",
            literal: "Tomate (objeto) três, por favor dê.",
            points: ["ください = pedido educado", "三つ = contagem genérica (1~10)."],
            grammar: "Nをください",
            breakdown: [
              { jp:"トマト", r:"とまと", m:"tomate", note:"objeto" },
              { jp:"を", r:"を", m:"objeto", note:"partícula" },
              { jp:"三つ", r:"みっつ", m:"três (itens)", note:"contador" },
              { jp:"ください", r:"ください", m:"por favor, dê", note:"pedido", vt:"他" }
            ],
            vocab: [
              { w:"ください", r:"ください", m:"por favor (dê)", vt:"他" },
              { w:"三つ", r:"みっつ", m:"três (itens)" }
            ]
          },
          {
            jp: "これはいくらですか。",
            jpRuby: "これはいくらですか。",
            reading: "これは いくらですか。",
            pt: "Quanto custa isto?",
            structure: "これは + いくらですか",
            literal: "Quanto é isto?",
            points: ["いくら = quanto (preço)"],
            grammar: "いくらですか",
            breakdown: [
              { jp:"これ", r:"これ", m:"isto", note:"pronome" },
              { jp:"は", r:"は", m:"tópico", note:"partícula" },
              { jp:"いくら", r:"いくら", m:"quanto (preço)", note:"interrogativo" },
              { jp:"ですか", r:"ですか", m:"é? (pergunta)", note:"cópula+Q" }
            ],
            vocab: [{ w:"いくら", r:"いくら", m:"quanto (preço)" }]
          },
          {
            jp: "お金が足りません。",
            jpRuby: "お<ruby>金<rt>かね</rt></ruby>が<ruby>足<rt>た</rt></ruby>りません。",
            reading: "おかねが たりません。",
            pt: "O dinheiro não é suficiente.",
            structure: "Nが + 足りません",
            literal: "Dinheiro (sujeito) não é suficiente.",
            points: ["足りる = verbo intransitivo (ser suficiente)."],
            grammar: "Nが足りる/足りない",
            breakdown: [
              { jp:"お金", r:"おかね", m:"dinheiro", note:"substantivo" },
              { jp:"が", r:"が", m:"sujeito/foco", note:"partícula" },
              { jp:"足りません", r:"たりません", m:"não é suficiente", note:"Vません", vt:"自" }
            ],
            vocab: [
              { w:"足りる", r:"たりる", m:"ser suficiente", vt:"自" },
              { w:"お金", r:"おかね", m:"dinheiro" }
            ]
          }
        ]
      },

      {
        id: "n5_weekend_plan",
        level: "N5",
        title: "週末の予定",
        desc: "〜たい / でも / から / いっしょに",
        tags: ["予定","週末"],
        lines: [
          {
            jp: "週末に友だちと映画を見たいです。",
            jpRuby: "<ruby>週末<rt>しゅうまつ</rt></ruby>に<ruby>友<rt>とも</rt></ruby>だちと<ruby>映画<rt>えいが</rt></ruby>を<ruby>見<rt>み</rt></ruby>たいです。",
            reading: "しゅうまつに ともだちと えいがを みたいです。",
            pt: "No fim de semana, quero ver um filme com um amigo.",
            structure: "週末に + 友だちと + 映画を + 見たいです",
            literal: "No fim de semana, com amigo, filme quero ver.",
            points: ["〜たい = desejo do falante", "見る = verbo transitivo (ver algo)."],
            grammar: "Vます + たいです",
            breakdown: [
              { jp:"週末", r:"しゅうまつ", m:"fim de semana", note:"tempo" },
              { jp:"に", r:"に", m:"em (tempo)", note:"partícula" },
              { jp:"友だち", r:"ともだち", m:"amigo", note:"pessoa" },
              { jp:"と", r:"と", m:"com", note:"partícula" },
              { jp:"映画", r:"えいが", m:"filme", note:"objeto" },
              { jp:"を", r:"を", m:"objeto", note:"partícula" },
              { jp:"見たいです", r:"みたいです", m:"quero ver", note:"Vたい", vt:"他" }
            ],
            vocab: [
              { w:"週末", r:"しゅうまつ", m:"fim de semana" },
              { w:"映画", r:"えいが", m:"filme" },
              { w:"見る", r:"みる", m:"ver/assistir", vt:"他" }
            ]
          },
          {
            jp: "でも、宿題が多いです。",
            jpRuby: "でも、<ruby>宿題<rt>しゅくだい</rt></ruby>が<ruby>多<rt>おお</rt></ruby>いです。",
            reading: "でも、しゅくだいが おおいです。",
            pt: "Mas há muita lição de casa.",
            structure: "でも + Nが多いです",
            literal: "Mas, a lição de casa é muita.",
            points: ["でも = mas", "多い = adjetivo-i"],
            grammar: "Nが多い",
            breakdown: [
              { jp:"でも", r:"でも", m:"mas", note:"conector" },
              { jp:"宿題", r:"しゅくだい", m:"lição de casa", note:"substantivo" },
              { jp:"が", r:"が", m:"sujeito/foco", note:"partícula" },
              { jp:"多い", r:"おおい", m:"muito", note:"adj-i" },
              { jp:"です", r:"です", m:"(forma educada)", note:"cópula" }
            ],
            vocab: [{ w:"宿題", r:"しゅくだい", m:"lição de casa" }]
          },
          {
            jp: "だから、土曜日の朝に勉強します。",
            jpRuby: "だから、<ruby>土曜日<rt>どようび</rt></ruby>の<ruby>朝<rt>あさ</rt></ruby>に<ruby>勉強<rt>べんきょう</rt></ruby>します。",
            reading: "だから、どようびの あさに べんきょうします。",
            pt: "Então, eu estudo na manhã de sábado.",
            structure: "だから + (tempo)に + 勉強します",
            literal: "Por isso, na manhã de sábado, estudo.",
            points: ["だから = por isso", "勉強する = ação (marcado aqui como verbo transitivo)."],
            grammar: "だから + Vます",
            breakdown: [
              { jp:"だから", r:"だから", m:"por isso", note:"conector" },
              { jp:"土曜日", r:"どようび", m:"sábado", note:"tempo" },
              { jp:"の", r:"の", m:"ligação", note:"partícula" },
              { jp:"朝", r:"あさ", m:"manhã", note:"tempo" },
              { jp:"に", r:"に", m:"em (tempo)", note:"partícula" },
              { jp:"勉強します", r:"べんきょうします", m:"estudo", note:"Vます", vt:"他" }
            ],
            vocab: [
              { w:"勉強する", r:"べんきょうする", m:"estudar", vt:"他" },
              { w:"土曜日", r:"どようび", m:"sábado" }
            ]
          }
        ]
      },

      /* =========================
         N5 (NOVOS — úteis)
      ========================== */
      {
        id: "n5_directions",
        level: "N5",
        title: "道を聞く",
        desc: "どこ / まっすぐ / 右 / 左 / 〜まで",
        tags: ["道","質問"],
        lines: [
          {
            jp: "すみません、駅はどこですか。",
            jpRuby: "すみません、<ruby>駅<rt>えき</rt></ruby>はどこですか。",
            reading: "すみません、えきは どこですか。",
            pt: "Com licença, onde fica a estação?",
            structure: "すみません、Nはどこですか",
            literal: "Com licença, (estação) onde é?",
            points: ["すみません = chamar atenção / desculpa", "どこですか = onde é?"],
            grammar: "Nはどこですか",
            breakdown: [
              { jp:"すみません", r:"すみません", m:"com licença / desculpe", note:"expressão" },
              { jp:"駅", r:"えき", m:"estação", note:"substantivo" },
              { jp:"は", r:"は", m:"tópico", note:"partícula" },
              { jp:"どこ", r:"どこ", m:"onde", note:"interrogativo" },
              { jp:"ですか", r:"ですか", m:"é? (pergunta)", note:"cópula+Q" }
            ],
            vocab: [
              { w:"駅", r:"えき", m:"estação" },
              { w:"どこ", r:"どこ", m:"onde" }
            ]
          },
          {
            jp: "この道をまっすぐ行ってください。",
            jpRuby: "この<ruby>道<rt>みち</rt></ruby>をまっすぐ<ruby>行<rt>い</rt></ruby>ってください。",
            reading: "このみちを まっすぐ いってください。",
            pt: "Siga reto por esta rua, por favor.",
            structure: "この道を + まっすぐ + 行ってください",
            literal: "Esta rua, reto, vá por favor.",
            points: ["〜てください = pedido educado", "行く = verbo intransitivo"],
            grammar: "Vてください",
            breakdown: [
              { jp:"道", r:"みち", m:"rua/caminho", note:"substantivo" },
              { jp:"を", r:"を", m:"caminho (rota)", note:"partícula" },
              { jp:"まっすぐ", r:"まっすぐ", m:"reto", note:"advérbio" },
              { jp:"行ってください", r:"いってください", m:"por favor, vá", note:"pedido", vt:"自" }
            ],
            vocab: [
              { w:"道", r:"みち", m:"rua/caminho" },
              { w:"まっすぐ", r:"まっすぐ", m:"reto" },
              { w:"行く", r:"いく", m:"ir", vt:"自" }
            ]
          },
          {
            jp: "次の角を右に曲がります。",
            jpRuby: "<ruby>次<rt>つぎ</rt></ruby>の<ruby>角<rt>かど</rt></ruby>を<ruby>右<rt>みぎ</rt></ruby>に<ruby>曲<rt>ま</rt></ruby>がります。",
            reading: "つぎの かどを みぎに まがります。",
            pt: "Vire à direita na próxima esquina.",
            structure: "次の角を + 右に + 曲がります",
            literal: "Na próxima esquina, à direita, viro.",
            points: ["右に = direção", "曲がる = verbo intransitivo (virar)"],
            grammar: "Nを + 方向に + Vます",
            breakdown: [
              { jp:"次", r:"つぎ", m:"próximo", note:"substantivo" },
              { jp:"角", r:"かど", m:"esquina", note:"substantivo" },
              { jp:"を", r:"を", m:"(ponto) da ação", note:"partícula" },
              { jp:"右", r:"みぎ", m:"direita", note:"direção" },
              { jp:"に", r:"に", m:"para (direção)", note:"partícula" },
              { jp:"曲がります", r:"まがります", m:"viro", note:"Vます", vt:"自" }
            ],
            vocab: [
              { w:"角", r:"かど", m:"esquina" },
              { w:"右", r:"みぎ", m:"direita" },
              { w:"曲がる", r:"まがる", m:"virar", vt:"自" }
            ]
          },
          {
            jp: "駅はここから五分ぐらいです。",
            jpRuby: "<ruby>駅<rt>えき</rt></ruby>はここから<ruby>五分<rt>ごふん</rt></ruby>ぐらいです。",
            reading: "えきは ここから ごふんぐらいです。",
            pt: "A estação fica a uns cinco minutos daqui.",
            structure: "Nは ここから + (tempo)ぐらいです",
            literal: "(A estação) daqui, cerca de cinco minutos é.",
            points: ["ぐらい = aproximadamente", "ここから = a partir daqui"],
            grammar: "ここから〜ぐらいです",
            breakdown: [
              { jp:"ここから", r:"ここから", m:"daqui", note:"origem" },
              { jp:"五分", r:"ごふん", m:"cinco minutos", note:"tempo" },
              { jp:"ぐらい", r:"ぐらい", m:"cerca de", note:"aprox." }
            ],
            vocab: [
              { w:"ここから", r:"ここから", m:"daqui" },
              { w:"五分", r:"ごふん", m:"cinco minutos" },
              { w:"ぐらい", r:"ぐらい", m:"mais ou menos" }
            ]
          }
        ]
      },

      {
        id: "n5_restaurant",
        level: "N5",
        title: "レストランで",
        desc: "注文 / 〜をください / おすすめ / ありますか",
        tags: ["食事","店"],
        lines: [
          {
            jp: "メニューを見せてください。",
            jpRuby: "メニューを<ruby>見<rt>み</rt></ruby>せてください。",
            reading: "めにゅーを みせてください。",
            pt: "Por favor, mostre o cardápio.",
            structure: "Nを + 見せてください",
            literal: "Cardápio, por favor mostre.",
            points: ["見せる = mostrar (transitivo)", "〜てください = pedido"],
            grammar: "Vてください",
            breakdown: [
              { jp:"メニュー", r:"めにゅー", m:"cardápio", note:"katakana" },
              { jp:"を", r:"を", m:"objeto", note:"partícula" },
              { jp:"見せてください", r:"みせてください", m:"por favor, mostre", note:"pedido", vt:"他" }
            ],
            vocab: [
              { w:"見せる", r:"みせる", m:"mostrar", vt:"他" },
              { w:"メニュー", r:"めにゅー", m:"cardápio" }
            ]
          },
          {
            jp: "水を一つください。",
            jpRuby: "<ruby>水<rt>みず</rt></ruby>を<ruby>一<rt>ひと</rt></ruby>つください。",
            reading: "みずを ひとつ ください。",
            pt: "Um copo de água, por favor.",
            structure: "Nを + 数 + ください",
            literal: "Água, um, por favor dê.",
            points: ["水 = água", "一つ = contador genérico"],
            grammar: "Nをください",
            breakdown: [
              { jp:"水", r:"みず", m:"água", note:"substantivo" },
              { jp:"を", r:"を", m:"objeto", note:"partícula" },
              { jp:"一つ", r:"ひとつ", m:"um (item)", note:"contador" },
              { jp:"ください", r:"ください", m:"por favor (dê)", note:"pedido", vt:"他" }
            ],
            vocab: [
              { w:"水", r:"みず", m:"água" },
              { w:"一つ", r:"ひとつ", m:"um (item)" },
              { w:"ください", r:"ください", m:"por favor (dê)", vt:"他" }
            ]
          },
          {
            jp: "おすすめは何ですか。",
            jpRuby: "おすすめは<ruby>何<rt>なん</rt></ruby>ですか。",
            reading: "おすすめは なんですか。",
            pt: "Qual é a recomendação (da casa)?",
            structure: "おすすめは + 何ですか",
            literal: "Recomendação, o que é?",
            points: ["おすすめ = recomendação", "何(なん) = o quê"],
            grammar: "Nは何ですか",
            breakdown: [
              { jp:"おすすめ", r:"おすすめ", m:"recomendação", note:"substantivo" },
              { jp:"は", r:"は", m:"tópico", note:"partícula" },
              { jp:"何", r:"なん", m:"o quê", note:"interrogativo" }
            ],
            vocab: [
              { w:"おすすめ", r:"おすすめ", m:"recomendação" },
              { w:"何", r:"なん", m:"o quê" }
            ]
          },
          {
            jp: "すみません、もう一度言ってください。",
            jpRuby: "すみません、もう<ruby>一度<rt>いちど</rt></ruby><ruby>言<rt>い</rt></ruby>ってください。",
            reading: "すみません、もういちど いってください。",
            pt: "Desculpe, pode dizer mais uma vez?",
            structure: "すみません、もう一度 + 言ってください",
            literal: "Desculpe, mais uma vez, diga por favor.",
            points: ["もう一度 = mais uma vez", "言う = dizer (aqui pedido)"],
            grammar: "Vてください",
            breakdown: [
              { jp:"もう一度", r:"もういちど", m:"mais uma vez", note:"advérbio" },
              { jp:"言ってください", r:"いってください", m:"por favor, diga", note:"pedido", vt:"他" }
            ],
            vocab: [
              { w:"一度", r:"いちど", m:"uma vez" },
              { w:"言う", r:"いう", m:"dizer", vt:"他" }
            ]
          }
        ]
      },

      {
        id: "n5_phone",
        level: "N5",
        title: "電話",
        desc: "もしもし / いますか / 〜てもいいですか",
        tags: ["電話","会話"],
        lines: [
          {
            jp: "もしもし、田中さんはいますか。",
            jpRuby: "もしもし、<ruby>田中<rt>たなか</rt></ruby>さんはいますか。",
            reading: "もしもし、たなかさんは いますか。",
            pt: "Alô, o Sr.(a) Tanaka está aí?",
            structure: "もしもし、Nさんはいますか",
            literal: "Alô, Tanaka está (presente)?",
            points: ["もしもし = alô (telefone)", "いる = existir/estar (pessoa/animal)"],
            grammar: "Nはいますか",
            breakdown: [
              { jp:"もしもし", r:"もしもし", m:"alô", note:"telefone" },
              { jp:"田中さん", r:"たなかさん", m:"Sr.(a) Tanaka", note:"nome" },
              { jp:"は", r:"は", m:"tópico", note:"partícula" },
              { jp:"いますか", r:"いますか", m:"está? (existe?)", note:"pergunta", vt:"自" }
            ],
            vocab: [
              { w:"いる", r:"いる", m:"estar/existir (pessoa)", vt:"自" },
              { w:"もしもし", r:"もしもし", m:"alô" }
            ]
          },
          {
            jp: "今ちょっと忙しいです。",
            jpRuby: "<ruby>今<rt>いま</rt></ruby>ちょっと<ruby>忙<rt>いそが</rt></ruby>しいです。",
            reading: "いま ちょっと いそがしいです。",
            pt: "Agora estou um pouco ocupado(a).",
            structure: "今 + ちょっと + 忙しいです",
            literal: "Agora, um pouco, ocupado(a) é.",
            points: ["ちょっと = um pouco", "忙しい = ocupado (adj-i)"],
            grammar: "adj-i + です",
            breakdown: [
              { jp:"今", r:"いま", m:"agora", note:"tempo" },
              { jp:"ちょっと", r:"ちょっと", m:"um pouco", note:"advérbio" },
              { jp:"忙しい", r:"いそがしい", m:"ocupado", note:"adj-i" }
            ],
            vocab: [
              { w:"今", r:"いま", m:"agora" },
              { w:"忙しい", r:"いそがしい", m:"ocupado" }
            ]
          },
          {
            jp: "あとで電話してもいいですか。",
            jpRuby: "あとで<ruby>電話<rt>でんわ</rt></ruby>してもいいですか。",
            reading: "あとで でんわしても いいですか。",
            pt: "Posso ligar mais tarde?",
            structure: "あとで + Vて + もいいですか",
            literal: "Depois, ligar, pode ser?",
            points: ["〜てもいいですか = pedir permissão", "電話する = ligar"],
            grammar: "Vてもいいですか",
            breakdown: [
              { jp:"あとで", r:"あとで", m:"mais tarde", note:"tempo" },
              { jp:"電話しても", r:"でんわしても", m:"mesmo se ligar (permitido)", note:"Vても", vt:"他" },
              { jp:"いいですか", r:"いいですか", m:"está ok? (permissão)", note:"pergunta" }
            ],
            vocab: [
              { w:"電話する", r:"でんわする", m:"ligar (telefone)", vt:"他" },
              { w:"あとで", r:"あとで", m:"mais tarde" }
            ]
          },
          {
            jp: "はい、大丈夫です。お願いします。",
            jpRuby: "はい、<ruby>大丈夫<rt>だいじょうぶ</rt></ruby>です。お<ruby>願<rt>ねが</rt></ruby>いします。",
            reading: "はい、だいじょうぶです。おねがいします。",
            pt: "Sim, tudo bem. Por favor.",
            structure: "大丈夫です / お願いします",
            literal: "Está tudo bem. Eu peço.",
            points: ["大丈夫 = ok", "お願いします = por favor (pedido)"],
            grammar: "expressões fixas",
            breakdown: [
              { jp:"大丈夫", r:"だいじょうぶ", m:"tudo bem", note:"expressão" },
              { jp:"お願いします", r:"おねがいします", m:"por favor", note:"pedido", vt:"他" }
            ],
            vocab: [
              { w:"大丈夫", r:"だいじょうぶ", m:"tudo bem" },
              { w:"お願いする", r:"おねがいする", m:"pedir", vt:"他" }
            ]
          }
        ]
      },

      /* =========================
         N4 (já existentes)
      ========================== */
      {
        id: "n4_moving_prep",
        level: "N4",
        title: "引っ越しの準備",
        desc: "ことになった / そう / ので / ておく",
        tags: ["生活","引っ越し"],
        lines: [
          {
            jp: "来月、仕事の都合で引っ越すことになりました。",
            jpRuby: "<ruby>来月<rt>らいげつ</rt></ruby>、<ruby>仕事<rt>しごと</rt></ruby>の<ruby>都合<rt>つごう</rt></ruby>で<ruby>引<rt>ひ</rt></ruby>っ<ruby>越<rt>こ</rt></ruby>すことになりました。",
            reading: "らいげつ、しごとの つごうで ひっこす ことに なりました。",
            pt: "No mês que vem, por causa do trabalho, ficou decidido que eu vou me mudar.",
            structure: "来月、(理由)で + V辞書形 + ことになりました",
            literal: "No mês que vem, por circunstâncias do trabalho, tornou-se decidido que vou me mudar.",
            points: [
              "〜ことになった = decisão definida por circunstância.",
              "引っ越す = verbo intransitivo (mudar-se)."
            ],
            grammar: "N4: ことになった",
            breakdown: [
              { jp:"来月", r:"らいげつ", m:"mês que vem", note:"tempo" },
              { jp:"仕事", r:"しごと", m:"trabalho", note:"substantivo" },
              { jp:"都合", r:"つごう", m:"circunstância", note:"razão" },
              { jp:"で", r:"で", m:"por causa de", note:"partícula" },
              { jp:"引っ越す", r:"ひっこす", m:"mudar-se", note:"V辞書形", vt:"自" },
              { jp:"ことになりました", r:"ことになりました", m:"ficou decidido", note:"padrão" }
            ],
            vocab: [
              { w:"都合", r:"つごう", m:"circunstância / conveniência" },
              { w:"引っ越す", r:"ひっこす", m:"mudar-se", vt:"自" }
            ]
          },
          {
            jp: "ダンボールは足りなくなりそうなので、多めに買っておきました。",
            jpRuby: "ダンボールは<ruby>足<rt>た</rt></ruby>りなくなりそうなので、<ruby>多<rt>おお</rt></ruby>めに<ruby>買<rt>か</rt></ruby>っておきました。",
            reading: "だんぼーるは たりなく なりそうなので、おおめに かっておきました。",
            pt: "Como parece que vai faltar caixa de papelão, comprei a mais com antecedência.",
            structure: "Nは Vなくなりそうなので、(quantidade)に Vておきました",
            literal: "Quanto às caixas, como parece que vão ficar insuficientes, comprei um pouco a mais e deixei preparado.",
            points: [
              "足りる = verbo intransitivo (ser suficiente).",
              "買う = verbo transitivo (comprar algo).",
              "〜ておく = preparar/adiantar."
            ],
            grammar: "N4: そう + ので + ておく",
            breakdown: [
              { jp:"足りなくなりそう", r:"たりなくなりそう", m:"parece que vai faltar", note:"mudança + そう", vt:"自" },
              { jp:"多めに", r:"おおめに", m:"um pouco a mais", note:"quantidade" },
              { jp:"買っておきました", r:"かっておきました", m:"comprei antecipadamente", note:"Vておく", vt:"他" }
            ],
            vocab: [
              { w:"足りる", r:"たりる", m:"ser suficiente", vt:"自" },
              { w:"買う", r:"かう", m:"comprar", vt:"他" },
              { w:"買っておく", r:"かっておく", m:"comprar antecipadamente", vt:"他" }
            ]
          }
        ]
      },

      {
        id: "n4_parttime_study",
        level: "N4",
        title: "アルバイトと勉強",
        desc: "ように / ために / しか / でも",
        tags: ["勉強","生活"],
        lines: [
          {
            jp: "日本語が上手になるために、毎日少しずつ練習しています。",
            jpRuby: "<ruby>日本語<rt>にほんご</rt></ruby>が<ruby>上手<rt>じょうず</rt></ruby>になるために、<ruby>毎日<rt>まいにち</rt></ruby><ruby>少<rt>すこ</rt></ruby>しずつ<ruby>練習<rt>れんしゅう</rt></ruby>しています。",
            reading: "にほんごが じょうずに なるために、まいにち すこしずつ れんしゅうしています。",
            pt: "Para ficar bom em japonês, eu treino um pouco todos os dias.",
            structure: "上手になるために、毎日 少しずつ 練習しています",
            literal: "Para se tornar bom, todos os dias aos poucos estou praticando.",
            points: [
              "〜ために = para (objetivo).",
              "なる = verbo intransitivo (tornar-se).",
              "練習する = ação (marcado aqui como verbo transitivo)."
            ],
            grammar: "N4: ために (objetivo)",
            breakdown: [
              { jp:"上手になる", r:"じょうずになる", m:"ficar bom (tornar-se)", note:"padrão", vt:"自" },
              { jp:"ために", r:"ために", m:"para (objetivo)", note:"conector" },
              { jp:"練習しています", r:"れんしゅうしています", m:"estou praticando", note:"Vている", vt:"他" }
            ],
            vocab: [
              { w:"なる", r:"なる", m:"tornar-se", vt:"自" },
              { w:"練習する", r:"れんしゅうする", m:"praticar", vt:"他" },
              { w:"少しずつ", r:"すこしずつ", m:"aos poucos" }
            ]
          },
          {
            jp: "忘れないように、新しい単語をノートに書いています。",
            jpRuby: "<ruby>忘<rt>わす</rt></ruby>れないように、<ruby>新<rt>あたら</rt></ruby>しい<ruby>単語<rt>たんご</rt></ruby>をノートに<ruby>書<rt>か</rt></ruby>いています。",
            reading: "わすれないように、あたらしい たんごを のーとに かいています。",
            pt: "Para não esquecer, eu escrevo as palavras novas no caderno.",
            structure: "忘れないように、NをNに書いています",
            literal: "Para não esquecer, palavras novas no caderno estou escrevendo.",
            points: ["〜ように = para (evitar/objetivo)", "書く = verbo transitivo (escrever algo)."],
            grammar: "N4: ように (evitar/objetivo)",
            breakdown: [
              { jp:"忘れない", r:"わすれない", m:"não esquecer", note:"negação", vt:"他" },
              { jp:"ように", r:"ように", m:"para (evitar)", note:"padrão" },
              { jp:"単語を", r:"たんごを", m:"palavras (objeto)", note:"を" },
              { jp:"ノートに", r:"のーとに", m:"no caderno", note:"に" },
              { jp:"書いています", r:"かいています", m:"estou escrevendo", note:"Vている", vt:"他" }
            ],
            vocab: [
              { w:"忘れる", r:"わすれる", m:"esquecer", vt:"他" },
              { w:"書く", r:"かく", m:"escrever", vt:"他" },
              { w:"単語", r:"たんご", m:"palavra (vocabulário)" }
            ]
          }
        ]
      },

      {
        id: "n4_health_habit",
        level: "N4",
        title: "健康のために",
        desc: "ようにする / すぎる / ほうがいい",
        tags: ["健康","習慣"],
        lines: [
          {
            jp: "健康のために、夜はあまり甘い物を食べないようにしています。",
            jpRuby: "<ruby>健康<rt>けんこう</rt></ruby>のために、<ruby>夜<rt>よる</rt></ruby>はあまり<ruby>甘<rt>あま</rt></ruby>い<ruby>物<rt>もの</rt></ruby>を<ruby>食<rt>た</rt></ruby>べないようにしています。",
            reading: "けんこうのために、よるは あまり あまいものを たべないようにしています。",
            pt: "Pela saúde, à noite eu tento não comer muitas coisas doces.",
            structure: "健康のために、夜は Nを Vないようにしています",
            literal: "Para a saúde, à noite, coisas doces eu tento não comer.",
            points: ["〜ようにしている = hábito/tentativa", "食べる = verbo transitivo (comer algo)."],
            grammar: "N4: Vないようにしている",
            breakdown: [
              { jp:"健康のために", r:"けんこうのために", m:"pela saúde / para a saúde", note:"objetivo" },
              { jp:"夜は", r:"よるは", m:"à noite (tópico)", note:"は" },
              { jp:"甘い物を", r:"あまいものを", m:"doces (objeto)", note:"を" },
              { jp:"食べないようにしています", r:"たべないようにしています", m:"tento não comer", note:"padrão", vt:"他" }
            ],
            vocab: [
              { w:"健康", r:"けんこう", m:"saúde" },
              { w:"食べる", r:"たべる", m:"comer", vt:"他" },
              { w:"ようにしている", r:"ようにしている", m:"tentar/habituar-se a" }
            ]
          },
          {
            jp: "運動は毎日したほうがいいと思います。",
            jpRuby: "<ruby>運動<rt>うんどう</rt></ruby>は<ruby>毎日<rt>まいにち</rt></ruby>したほうがいいと<ruby>思<rt>おも</rt></ruby>います。",
            reading: "うんどうは まいにち したほうがいいと おもいます。",
            pt: "Eu acho que é melhor fazer exercício todos os dias.",
            structure: "Nは Vたほうがいいと思います",
            literal: "Quanto a exercício, acho que é melhor fazer.",
            points: ["〜たほうがいい = recomendação", "思う = verbo transitivo (achar algo)."],
            grammar: "N4: Vたほうがいい",
            breakdown: [
              { jp:"運動", r:"うんどう", m:"exercício", note:"tópico" },
              { jp:"したほうがいい", r:"したほうがいい", m:"é melhor fazer", note:"padrão" },
              { jp:"思います", r:"おもいます", m:"acho/penso", note:"Vます", vt:"他" }
            ],
            vocab: [
              { w:"運動する", r:"うんどうする", m:"fazer exercício", vt:"他" },
              { w:"思う", r:"おもう", m:"achar/pensar", vt:"他" }
            ]
          }
        ]
      },

      /* =========================
         N4 (NOVOS — úteis)
      ========================== */
      {
        id: "n4_travel_plan",
        level: "N4",
        title: "旅行の計画",
        desc: "つもり / かもしれない / 予約する / 〜てみる",
        tags: ["旅行","予定"],
        lines: [
          {
            jp: "来週、京都へ行くつもりです。",
            jpRuby: "<ruby>来週<rt>らいしゅう</rt></ruby>、<ruby>京都<rt>きょうと</rt></ruby>へ<ruby>行<rt>い</rt></ruby>くつもりです。",
            reading: "らいしゅう、きょうとへ いくつもりです。",
            pt: "Na semana que vem, pretendo ir a Kyoto.",
            structure: "V辞書形 + つもりです",
            literal: "Tenho a intenção de ir.",
            points: ["つもり = intenção/planejamento", "へ = direção/destino (similar a に)"],
            grammar: "N4: V辞書形 + つもりです",
            breakdown: [
              { jp:"来週", r:"らいしゅう", m:"semana que vem", note:"tempo" },
              { jp:"京都", r:"きょうと", m:"Kyoto", note:"lugar" },
              { jp:"へ", r:"へ", m:"para (direção)", note:"partícula" },
              { jp:"行く", r:"いく", m:"ir", note:"V辞書形", vt:"自" },
              { jp:"つもりです", r:"つもりです", m:"pretendo / tenho intenção", note:"padrão" }
            ],
            vocab: [
              { w:"つもり", r:"つもり", m:"intenção" },
              { w:"行く", r:"いく", m:"ir", vt:"自" },
              { w:"来週", r:"らいしゅう", m:"semana que vem" }
            ]
          },
          {
            jp: "ホテルを予約したほうがいいかもしれません。",
            jpRuby: "ホテルを<ruby>予約<rt>よやく</rt></ruby>したほうがいいかもしれません。",
            reading: "ほてるを よやくしたほうがいい かもしれません。",
            pt: "Talvez seja melhor reservar o hotel.",
            structure: "Vたほうがいい + かもしれません",
            literal: "Pode ser que seja melhor fazer.",
            points: ["かもしれない = talvez", "予約する = reservar (transitivo)"],
            grammar: "N4: かもしれない",
            breakdown: [
              { jp:"ホテル", r:"ほてる", m:"hotel", note:"katakana" },
              { jp:"を", r:"を", m:"objeto", note:"partícula" },
              { jp:"予約する", r:"よやくする", m:"reservar", note:"verbo", vt:"他" },
              { jp:"したほうがいい", r:"したほうがいい", m:"é melhor fazer", note:"padrão" },
              { jp:"かもしれません", r:"かもしれません", m:"talvez", note:"padrão" }
            ],
            vocab: [
              { w:"予約する", r:"よやくする", m:"reservar", vt:"他" },
              { w:"かもしれない", r:"かもしれない", m:"talvez" }
            ]
          },
          {
            jp: "時間があれば、有名なお寺を見てみたいです。",
            jpRuby: "<ruby>時間<rt>じかん</rt></ruby>があれば、<ruby>有名<rt>ゆうめい</rt></ruby>なお<ruby>寺<rt>てら</rt></ruby>を<ruby>見<rt>み</rt></ruby>てみたいです。",
            reading: "じかんが あれば、ゆうめいな おてらを みてみたいです。",
            pt: "Se eu tiver tempo, eu gostaria de tentar ver templos famosos.",
            structure: "時間があれば、NをVてみたいです",
            literal: "Se houver tempo, quero tentar ver.",
            points: ["〜てみる = tentar/experimentar", "あれば = se houver"],
            grammar: "N4: Vてみる",
            breakdown: [
              { jp:"時間", r:"じかん", m:"tempo", note:"substantivo" },
              { jp:"があれば", r:"があれば", m:"se houver", note:"condicional" },
              { jp:"有名", r:"ゆうめい", m:"famoso", note:"adj-na" },
              { jp:"お寺", r:"おてら", m:"templo", note:"substantivo" },
              { jp:"見てみたい", r:"みてみたい", m:"quero tentar ver", note:"Vてみる+たい", vt:"他" }
            ],
            vocab: [
              { w:"有名", r:"ゆうめい", m:"famoso" },
              { w:"寺", r:"てら", m:"templo" },
              { w:"見てみる", r:"みてみる", m:"tentar ver", vt:"他" }
            ]
          }
        ]
      },

      {
        id: "n4_work_request",
        level: "N4",
        title: "職場のお願い",
        desc: "〜ていただけませんか / ので / までに",
        tags: ["仕事","丁寧"],
        lines: [
          {
            jp: "すみません、この資料を確認していただけませんか。",
            jpRuby: "すみません、この<ruby>資料<rt>しりょう</rt></ruby>を<ruby>確認<rt>かくにん</rt></ruby>していただけませんか。",
            reading: "すみません、このしりょうを かくにんして いただけませんか。",
            pt: "Com licença, você poderia verificar este material?",
            structure: "Nを Vていただけませんか",
            literal: "Você não poderia (me dar o favor de) verificar?",
            points: ["〜ていただけませんか = pedido muito educado", "確認する = confirmar/verificar"],
            grammar: "N4: Vていただけませんか",
            breakdown: [
              { jp:"資料", r:"しりょう", m:"material/documento", note:"substantivo" },
              { jp:"を", r:"を", m:"objeto", note:"partícula" },
              { jp:"確認する", r:"かくにんする", m:"verificar", note:"verbo", vt:"他" },
              { jp:"していただけませんか", r:"していただけませんか", m:"poderia fazer para mim?", note:"pedido" }
            ],
            vocab: [
              { w:"資料", r:"しりょう", m:"material/documento" },
              { w:"確認する", r:"かくにんする", m:"verificar", vt:"他" },
              { w:"いただけませんか", r:"いただけませんか", m:"poderia? (pedido educado)" }
            ]
          },
          {
            jp: "明日の午後までにメールを送ってください。",
            jpRuby: "<ruby>明日<rt>あした</rt></ruby>の<ruby>午後<rt>ごご</rt></ruby>までにメールを<ruby>送<rt>おく</rt></ruby>ってください。",
            reading: "あしたの ごごまでに めーるを おくってください。",
            pt: "Por favor, envie o e-mail até amanhã à tarde.",
            structure: "〜までに + NをVてください",
            literal: "Até (prazo), envie por favor.",
            points: ["までに = até (prazo limite)", "送る = enviar (transitivo)"],
            grammar: "N4: までに (prazo)",
            breakdown: [
              { jp:"明日の午後", r:"あしたのごご", m:"amanhã à tarde", note:"tempo" },
              { jp:"までに", r:"までに", m:"até (prazo)", note:"partícula" },
              { jp:"メール", r:"めーる", m:"e-mail", note:"objeto" },
              { jp:"を", r:"を", m:"objeto", note:"partícula" },
              { jp:"送ってください", r:"おくってください", m:"por favor, envie", note:"pedido", vt:"他" }
            ],
            vocab: [
              { w:"までに", r:"までに", m:"até (prazo)" },
              { w:"送る", r:"おくる", m:"enviar", vt:"他" },
              { w:"午後", r:"ごご", m:"tarde" }
            ]
          },
          {
            jp: "急いでいるので、先にこちらをお願いします。",
            jpRuby: "<ruby>急<rt>いそ</rt></ruby>いでいるので、<ruby>先<rt>さき</rt></ruby>にこちらをお<ruby>願<rt>ねが</rt></ruby>いします。",
            reading: "いそいでいるので、さきに こちらを おねがいします。",
            pt: "Como estou com pressa, por favor, faça este primeiro.",
            structure: "Vているので、先に Nをお願いします",
            literal: "Como estou apressado, primeiro isto, por favor.",
            points: ["〜ので = porque/como (mais suave)", "急ぐ = apressar-se (intransitivo aqui)"],
            grammar: "N4: ので (causa)",
            breakdown: [
              { jp:"急いでいる", r:"いそいでいる", m:"estar com pressa", note:"Vている", vt:"自" },
              { jp:"ので", r:"ので", m:"porque/como", note:"conector" },
              { jp:"先に", r:"さきに", m:"primeiro / antes", note:"advérbio" },
              { jp:"こちら", r:"こちら", m:"este (lado/isto)", note:"polido" },
              { jp:"お願いします", r:"おねがいします", m:"por favor", note:"pedido", vt:"他" }
            ],
            vocab: [
              { w:"急ぐ", r:"いそぐ", m:"apressar-se", vt:"自" },
              { w:"先に", r:"さきに", m:"primeiro" },
              { w:"ので", r:"ので", m:"porque (suave)" }
            ]
          }
        ]
      },

      {
        id: "n4_delay_notice",
        level: "N4",
        title: "遅れの連絡",
        desc: "遅れる / 〜そうです / もし / すぐ",
        tags: ["連絡","時間"],
        lines: [
          {
            jp: "電車が遅れているそうです。",
            jpRuby: "<ruby>電車<rt>でんしゃ</rt></ruby>が<ruby>遅<rt>おく</rt></ruby>れているそうです。",
            reading: "でんしゃが おくれている そうです。",
            pt: "Parece que o trem está atrasado (ouvi dizer).",
            structure: "Vている + そうです",
            literal: "Ouvi que está atrasando.",
            points: ["〜そうです (ouvi dizer) = informação indireta", "遅れる = atrasar (intransitivo)"],
            grammar: "N4: そうです (ouvi dizer)",
            breakdown: [
              { jp:"電車", r:"でんしゃ", m:"trem", note:"substantivo" },
              { jp:"が", r:"が", m:"sujeito/foco", note:"partícula" },
              { jp:"遅れている", r:"おくれている", m:"estar atrasando", note:"Vている", vt:"自" },
              { jp:"そうです", r:"そうです", m:"ouvi dizer / parece que", note:"padrão" }
            ],
            vocab: [
              { w:"遅れる", r:"おくれる", m:"atrasar", vt:"自" },
              { w:"そうです", r:"そうです", m:"ouvi dizer (reportado)" }
            ]
          },
          {
            jp: "もし間に合わなかったら、すぐ連絡します。",
            jpRuby: "もし<ruby>間<rt>ま</rt></ruby>に<ruby>合<rt>あ</rt></ruby>わなかったら、すぐ<ruby>連絡<rt>れんらく</rt></ruby>します。",
            reading: "もし まにあわなかったら、すぐ れんらくします。",
            pt: "Se eu não conseguir chegar a tempo, aviso imediatamente.",
            structure: "もし Vなかったら、すぐ NをVます",
            literal: "Se não der tempo, imediatamente eu contato.",
            points: ["もし = se (ênfase)", "間に合う = dar tempo / chegar a tempo"],
            grammar: "N4: もし〜たら",
            breakdown: [
              { jp:"もし", r:"もし", m:"se (caso)", note:"condicional" },
              { jp:"間に合わない", r:"まにあわない", m:"não dar tempo", note:"negação", vt:"自" },
              { jp:"すぐ", r:"すぐ", m:"imediatamente", note:"advérbio" },
              { jp:"連絡する", r:"れんらくする", m:"contatar/avisar", note:"verbo", vt:"他" }
            ],
            vocab: [
              { w:"間に合う", r:"まにあう", m:"dar tempo / chegar a tempo", vt:"自" },
              { w:"連絡する", r:"れんらくする", m:"contatar/avisar", vt:"他" },
              { w:"すぐ", r:"すぐ", m:"imediatamente" }
            ]
          },
          {
            jp: "すみませんが、少し待ってもらえますか。",
            jpRuby: "すみませんが、<ruby>少<rt>すこ</rt></ruby>し<ruby>待<rt>ま</rt></ruby>ってもらえますか。",
            reading: "すみませんが、すこし まってもらえますか。",
            pt: "Desculpe, você pode esperar um pouco?",
            structure: "Vて + もらえますか",
            literal: "Você pode me dar o favor de esperar?",
            points: ["〜てもらえますか = pedido educado (mais leve que いただけませんか)"],
            grammar: "N4: Vてもらえますか",
            breakdown: [
              { jp:"少し", r:"すこし", m:"um pouco", note:"quantidade" },
              { jp:"待つ", r:"まつ", m:"esperar", note:"verbo", vt:"自" },
              { jp:"待ってもらえますか", r:"まってもらえますか", m:"pode esperar para mim?", note:"pedido" }
            ],
            vocab: [
              { w:"待つ", r:"まつ", m:"esperar", vt:"自" },
              { w:"少し", r:"すこし", m:"um pouco" }
            ]
          }
        ]
      }
    ];

    /***********************
     * STATE + STORAGE
     ***********************/
    const LS_KEY = "nihongo_textlab_v5";
    const defaultState = {
      texts: [],
      activeTextId: null,
      ui: {
        tab: "TAB_TEXT",
        showFurigana: true,
        showReading: true,
        showPT: true,
        fontScale: 1,
        hue: 210,
        levelView: "N5",
        appearance: "light"
      },
      progress: {},
      deck: {}
    };

    function mergeDeep(target, source){
      if(typeof source !== "object" || source === null) return target;
      for(const k of Object.keys(source)){
        if(Array.isArray(source[k])) target[k] = source[k];
        else if(typeof source[k] === "object" && source[k] !== null){
          if(typeof target[k] !== "object" || target[k] === null) target[k] = {};
          target[k] = mergeDeep(target[k], source[k]);
        }else{
          target[k] = source[k];
        }
      }
      return target;
    }

    function loadState(){
      try{
        const raw = localStorage.getItem(LS_KEY);
        if(!raw) return structuredClone(defaultState);
        const parsed = JSON.parse(raw);
        return mergeDeep(structuredClone(defaultState), parsed);
      }catch(e){
        return structuredClone(defaultState);
      }
    }

    let state = loadState();

    let saveTimer = null;
    function saveStateDebounced(ms=350){
      clearTimeout(saveTimer);
      saveTimer = setTimeout(()=>{
        localStorage.setItem(LS_KEY, JSON.stringify(state));
        refreshKPIs();
      }, ms);
    }

    function saveStateNow(){
      clearTimeout(saveTimer);
      localStorage.setItem(LS_KEY, JSON.stringify(state));
      refreshKPIs();
    }

    /***********************
     * HELPERS
     ***********************/
    const $ = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
    const clamp = (v,min,max)=>Math.max(min,Math.min(max,v));

    function allTexts(){
      return [...builtInTexts, ...(state.texts || [])];
    }
    function getTextById(id){
      return allTexts().find(t => t.id === id) || null;
    }

    function ensureProgress(textId){
      if(!state.progress[textId]){
        state.progress[textId] = { doneLines:{}, bookmarked:false, notes:"" };
      }
      return state.progress[textId];
    }

    function wordKey(v){ return `${v.w}__${v.r}__${v.m}`; }

    function escapeHTML(s){
      return (s ?? "").replace(/[&<>"']/g, m => ({
        "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"
      }[m]));
    }

    function shuffle(a){
      const arr = a.slice();
      for(let i=arr.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        [arr[i],arr[j]]=[arr[j],arr[i]];
      }
      return arr;
    }

    // ✅ EXIBIÇÃO EM PT-BR
    function vtLabel(vt){
      if(vt === "他") return "Verbo transitivo";
      if(vt === "自") return "Verbo intransitivo";
      return "";
    }

    /***********************
     * THEME + Appearance
     ***********************/
    function applyAppearance(){
      const isDark = (state.ui.appearance === "dark");
      document.body.classList.toggle("theme-dark", isDark);
      $("#btnTheme").textContent = `Aparência: ${isDark ? "Escuro" : "Claro"}`;
    }

    function toggleAppearance(){
      state.ui.appearance = (state.ui.appearance === "dark") ? "light" : "dark";
      saveStateDebounced();
      applyAppearance();
      toast(state.ui.appearance === "dark" ? "Escuro" : "Claro");
    }

    function startTheme(){
      let hue = state.ui?.hue ?? 210;

      setInterval(()=>{
        hue = (hue + 9) % 360;
        document.documentElement.style.setProperty("--hue", hue);
        state.ui.hue = hue;
        if(hue % 90 === 0) saveStateDebounced(0);
      }, 3500);

      document.documentElement.style.setProperty("--hue", hue);
    }

    /***********************
     * LEVEL VIEW
     ***********************/
    function setLevelView(level){
      state.ui.levelView = level;
      $("#segN5").classList.toggle("active", level==="N5");
      $("#segN4").classList.toggle("active", level==="N4");
      saveStateDebounced();
      renderLibrary();

      const active = getTextById(state.activeTextId);
      if(!active || active.level !== level){
        const first = allTexts().find(t=>t.level===level);
        state.activeTextId = first ? first.id : null;
        saveStateDebounced();
      }
      renderMain();
    }

    /***********************
     * RENDER: LIBRARY
     ***********************/
    function renderLibrary(){
      const list = $("#libraryList");
      const q = $("#searchInput").value.trim().toLowerCase();
      const level = state.ui.levelView || "N5";

      const texts = allTexts()
        .filter(t => t.level === level)
        .filter(t => {
          if(!q) return true;
          const hay = `${t.title} ${t.desc} ${(t.tags||[]).join(" ")} ${(t.lines||[]).map(l=>l.jp).join(" ")}`;
          return hay.toLowerCase().includes(q);
        });

      $("#kpiTexts").textContent = texts.length;

      list.innerHTML = texts.map(t=>{
        const p = ensureProgress(t.id);
        const done = Object.keys(p.doneLines||{}).length;
        const total = (t.lines||[]).length;
        const pct = total ? Math.round((done/total)*100) : 0;

        return `
          <div class="item ${t.id===state.activeTextId ? "active":""}" data-id="${escapeHTML(t.id)}">
            <div class="itemTop">
              <div style="min-width:0">
                <p class="itemTitle">${escapeHTML(t.title)}</p>
                <p class="itemDesc">${escapeHTML(t.desc || "")}</p>
              </div>
              <div style="display:flex;flex-direction:column;gap:6px;align-items:flex-end">
                <span class="tag"><b>${escapeHTML(t.level)}</b></span>
                <span class="tag">${done}/${total} • ${pct}%</span>
                <span class="tag">${p.bookmarked ? "★" : "☆"}</span>
              </div>
            </div>
          </div>
        `;
      }).join("") || `<div class="muted" style="font-size:12px">Nenhum texto encontrado neste nível.</div>`;

      $$(".item", list).forEach(el=>{
        el.addEventListener("click", ()=>{
          const id = el.getAttribute("data-id");
          setActiveText(id);
        });
      });
    }

    /***********************
     * RENDER: MAIN
     ***********************/
    function setActiveText(id){
      state.activeTextId = id;
      ensureProgress(id);
      saveStateDebounced();
      renderLibrary();
      renderMain();
    }

    function setTab(tab){
      state.ui.tab = tab;
      saveStateDebounced();
      renderMain();
    }

    function applyFontScale(scale){
      state.ui.fontScale = clamp(scale, 0.85, 1.35);
      document.documentElement.style.setProperty("--fontScale", state.ui.fontScale);
      saveStateDebounced();
    }

    function syncToggleButtons(){
      const f = state.ui.showFurigana ? "ON" : "OFF";
      const r = state.ui.showReading ? "ON" : "OFF";
      const p = state.ui.showPT ? "ON" : "OFF";

      ["#btnToggleFuri","#btnToggleFuri2","#btnToggleFuriFocus"].forEach(id=>{
        const b = $(id); if(b) b.textContent = `Furigana: ${f}`;
      });
      ["#btnToggleReading","#btnToggleReading2","#btnToggleReadingFocus"].forEach(id=>{
        const b = $(id); if(b) b.textContent = `Leitura: ${r}`;
      });
      ["#btnTogglePT","#btnTogglePT2","#btnTogglePTFocus"].forEach(id=>{
        const b = $(id); if(b) b.textContent = `Tradução: ${p}`;
      });

      $("#segN5").classList.toggle("active", (state.ui.levelView||"N5")==="N5");
      $("#segN4").classList.toggle("active", (state.ui.levelView||"N5")==="N4");
    }

    function toggleFurigana(){ state.ui.showFurigana = !state.ui.showFurigana; saveStateDebounced(); syncToggleButtons(); renderMain(); }
    function toggleReading(){ state.ui.showReading = !state.ui.showReading; saveStateDebounced(); syncToggleButtons(); renderMain(); }
    function togglePT(){ state.ui.showPT = !state.ui.showPT; saveStateDebounced(); syncToggleButtons(); renderMain(); }

    function fontPlus(){ applyFontScale((state.ui.fontScale||1) + 0.05); renderMain(); }
    function fontMinus(){ applyFontScale((state.ui.fontScale||1) - 0.05); renderMain(); }

    function renderMain(){
      const text = getTextById(state.activeTextId);
      const empty = $("#emptyState");

      applyFontScale(state.ui.fontScale || 1);
      syncToggleButtons();

      if(!text){
        empty.style.display = "block";
        ["#tab_TEXT","#tab_VOCAB","#tab_FLASH","#tab_QUIZ","#tab_NOTES"].forEach(id=>$(id).style.display="none");
        $("#textTitle").textContent = "Selecione um texto";
        $("#textMeta").innerHTML = "";
        return;
      }

      empty.style.display = "none";

      $("#textTitle").textContent = text.title;
      const pr = ensureProgress(text.id);

      $("#textMeta").innerHTML = `
        <span class="tag"><b>${escapeHTML(text.level)}</b></span>
        <span class="tag">🧾 ${text.lines.length} linhas</span>
        <span class="tag">✅ ${Object.keys(pr.doneLines||{}).length} revisadas</span>
        <span class="tag">${pr.bookmarked ? "★ Favorito" : "☆"}</span>
      `;

      const tab = state.ui.tab || "TAB_TEXT";
      const map = {
        TAB_TEXT: "#tab_TEXT",
        TAB_VOCAB: "#tab_VOCAB",
        TAB_FLASH: "#tab_FLASH",
        TAB_QUIZ: "#tab_QUIZ",
        TAB_NOTES: "#tab_NOTES"
      };
      for(const k of Object.keys(map)){
        $(map[k]).style.display = (k === tab) ? "block" : "none";
      }
      $$(".tab").forEach(t=>{
        t.classList.toggle("active", t.dataset.tab === tab);
      });

      renderLines(text, $("#lineList"));
      renderLines(text, $("#focusLineList"));
      renderVocab(text);
      renderNotes(text);
      renderDeckUI();
    }

    function renderLines(text, root){
      const pr = ensureProgress(text.id);
      const showF = !!state.ui.showFurigana;
      const showR = !!state.ui.showReading;
      const showPT = !!state.ui.showPT;

      root.innerHTML = text.lines.map((ln, idx)=>{
        const done = !!pr.doneLines?.[idx];
        const jpHTML = (showF && ln.jpRuby) ? ln.jpRuby : escapeHTML(ln.jp);
        const reading = showR ? `<div class="reading">${escapeHTML(ln.reading||"")}</div>` : "";

        const noteKey = `lineNote_${text.id}_${idx}`;
        const lineNote = (state.progress[text.id]?.[noteKey]) || "";

        const structure = ln.structure ? escapeHTML(ln.structure) : "—";
        const literal = ln.literal ? escapeHTML(ln.literal) : "—";
        const points = (ln.points||[]).length ? (ln.points||[]).map(x=>`<span class="tag" style="margin:4px 6px 0 0">• ${escapeHTML(x)}</span>`).join("") : "—";

        const breakdown = (ln.breakdown||[]).length
          ? (ln.breakdown||[]).map(b=>{
              const vt = b.vt ? ` <span class="tag" style="margin-left:6px">${escapeHTML(vtLabel(b.vt))}</span>` : "";
              return `
                <div class="tag" style="margin:4px 6px 0 0">
                  <b>${escapeHTML(b.jp)}</b> ${escapeHTML(b.r||"")} • ${escapeHTML(b.m||"")}
                  ${b.note ? `— <span class="muted">${escapeHTML(b.note)}</span>` : ""}
                  ${vt}
                </div>
              `;
            }).join("")
          : "—";

        const ptBox = showPT
          ? `<div class="box">
              <div class="boxTitle"><b>Tradução (PT)</b></div>
              <p>${escapeHTML(ln.pt || "—")}</p>
            </div>`
          : `<div class="box">
              <div class="boxTitle"><b>Tradução (PT)</b></div>
              <p class="muted">Oculta (Tradução: OFF)</p>
            </div>`;

        return `
          <div class="lineCard" data-idx="${idx}">
            <div class="lineTop">
              <div class="lineLeft">
                <p class="jp">${jpHTML}</p>
                ${reading}
              </div>
              <div class="lineBadges">
                <label class="chk" title="Marque quando revisar esta linha">
                  <input type="checkbox" ${done ? "checked":""} />
                  Revisada
                </label>
                <button class="btn" data-action="toggle">Detalhes</button>
              </div>
            </div>

            <div class="details">
              <div class="notes">
                ${ptBox}

                <div class="box">
                  <div class="boxTitle"><b>Estrutura</b></div>
                  <p style="font-family: var(--mono);">${structure}</p>
                </div>

                <div class="box">
                  <div class="boxTitle"><b>Literal</b></div>
                  <p>${literal}</p>
                </div>

                <div class="box">
                  <div class="boxTitle"><b>Pontos</b></div>
                  <p>${points}</p>
                </div>

                <div class="box">
                  <div class="boxTitle"><b>Breakdown</b></div>
                  <p>${breakdown}</p>
                </div>

                <div class="box">
                  <div class="boxTitle"><b>Gramática</b></div>
                  <p>${escapeHTML(ln.grammar || "—")}</p>
                </div>

                <div class="box">
                  <div class="boxTitle"><b>Vocabulário (linha)</b></div>
                  <p>
                    ${(ln.vocab||[]).map(v=>{
                      const vt = v.vt ? ` <span class="tag" style="margin-left:6px">${escapeHTML(vtLabel(v.vt))}</span>` : "";
                      return `<span class="tag" style="margin:4px 6px 0 0">🧩 <b>${escapeHTML(v.w)}</b> ${escapeHTML(v.r)} • ${escapeHTML(v.m)}${vt}</span>`;
                    }).join("") || "—"}
                  </p>
                  <div class="row" style="margin-top:10px">
                    <button class="btn btnPrimary" data-action="addLineVocab">+ Deck (linha)</button>
                    <button class="btn" data-action="copyJP">Copiar JP</button>
                  </div>
                </div>

                <div class="box">
                  <div class="boxTitle"><b>Minha nota</b></div>
                  <textarea class="textarea" data-action="lineNote" placeholder="Escreva aqui (auto-save)..." style="min-height:90px">${escapeHTML(lineNote)}</textarea>
                </div>
              </div>
            </div>
          </div>
        `;
      }).join("");

      $$(".lineCard", root).forEach(card=>{
        const idx = Number(card.getAttribute("data-idx"));
        const chk = $("input[type=checkbox]", card);
        const btnToggle = $("[data-action=toggle]", card);

        chk.addEventListener("change", ()=>{
          const pr2 = ensureProgress(text.id);
          if(chk.checked) pr2.doneLines[idx] = true;
          else delete pr2.doneLines[idx];
          saveStateDebounced(0);
          renderLibrary();
          renderMain();
        });

        btnToggle.addEventListener("click", ()=> card.classList.toggle("open"));
        $(".jp", card).addEventListener("click", ()=> card.classList.toggle("open"));

        const noteArea = $("[data-action=lineNote]", card);
        noteArea.addEventListener("input", ()=>{
          const key = `lineNote_${text.id}_${idx}`;
          state.progress[text.id][key] = noteArea.value;
          saveStateDebounced(450);
        });

        $("[data-action=addLineVocab]", card).addEventListener("click", ()=>{
          addVocabToDeck(text.lines[idx].vocab||[]);
          renderDeckUI();
          refreshKPIs();
          toast("Adicionado ao deck ✅");
        });

        $("[data-action=copyJP]", card).addEventListener("click", async ()=>{
          try{
            await navigator.clipboard.writeText(text.lines[idx].jp);
            toast("JP copiado ✅");
          }catch{
            toast("Não foi possível copiar.");
          }
        });
      });
    }

    function aggregateVocab(text){
      const map = new Map();
      for(const ln of (text.lines||[])){
        for(const v of (ln.vocab||[])){
          const k = wordKey(v);
          if(!map.has(k)) map.set(k, { ...v, count: 0 });
          map.get(k).count += 1;
        }
      }
      return Array.from(map.values()).sort((a,b)=>b.count-a.count || a.w.localeCompare(b.w));
    }

    function renderVocab(text){
      const grid = $("#vocabGrid");
      const vocab = aggregateVocab(text);

      if(!vocab.length){
        grid.innerHTML = `<div class="muted" style="font-size:12px">Sem vocabulário neste texto.</div>`;
        return;
      }

      grid.innerHTML = vocab.map(v=>{
        const k = wordKey(v);
        const inDeck = !!state.deck[k];
        const vt = v.vt ? `<span class="tag">${escapeHTML(vtLabel(v.vt))}</span>` : "";
        return `
          <div class="vocabCard">
            <div>
              <p class="w">${escapeHTML(v.w)}</p>
              <div class="r">${escapeHTML(v.r)}</div>
              <div class="m">${escapeHTML(v.m)}</div>
              <div style="margin-top:10px" class="row">
                <span class="tag">📍 ${v.count}x</span>
                ${vt}
              </div>
            </div>
            <div class="vocabRight">
              <button class="btn ${inDeck ? "" : "btnPrimary"}" data-add="${escapeHTML(k)}">
                ${inDeck ? "No deck ✓" : "+ Deck"}
              </button>
              <button class="btn" data-remove="${escapeHTML(k)}">Remover</button>
            </div>
          </div>
        `;
      }).join("");

      $$("[data-add]", grid).forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const k = btn.getAttribute("data-add");
          const v = vocab.find(x=>wordKey(x)===k);
          if(v) addVocabToDeck([v]);
          renderVocab(text);
          renderDeckUI();
          refreshKPIs();
          toast("Adicionado ✅");
        });
      });

      $$("[data-remove]", grid).forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const k = btn.getAttribute("data-remove");
          if(state.deck[k]) delete state.deck[k];
          saveStateDebounced();
          renderVocab(text);
          renderDeckUI();
          refreshKPIs();
          toast("Removido.");
        });
      });
    }

    function renderNotes(text){
      const area = $("#textNotes");
      const pr = ensureProgress(text.id);
      area.value = pr.notes || "";
      area.oninput = ()=>{
        pr.notes = area.value;
        saveStateDebounced(450);
      };
    }

    /***********************
     * DECK
     ***********************/
    function addVocabToDeck(arr){
      const now = Date.now();
      for(const v of arr){
        const k = wordKey(v);
        if(!state.deck[k]){
          state.deck[k] = { w:v.w, r:v.r, m:v.m, vt:v.vt||"", due: now, ease: 2.2, streak: 0, last: 0, seen: 0 };
        }
      }
      saveStateDebounced();
    }

    function deckDueList(){
      const now = Date.now();
      return Object.values(state.deck)
        .filter(c => (c.due ?? 0) <= now)
        .sort((a,b)=>(a.due??0)-(b.due??0));
    }

    let currentCardKey = null;

    function pickNextCard(){
      const due = deckDueList();
      if(due.length){
        currentCardKey = `${due[0].w}__${due[0].r}__${due[0].m}`;
        return state.deck[currentCardKey];
      }
      const all = Object.values(state.deck);
      if(!all.length){ currentCardKey = null; return null; }
      all.sort((a,b)=>(a.due??0)-(b.due??0));
      currentCardKey = `${all[0].w}__${all[0].r}__${all[0].m}`;
      return state.deck[currentCardKey];
    }

    function renderDeckUI(){
      const card = pickNextCard();
      const flash = $("#flashCard");
      flash.classList.remove("revealed");

      const total = Object.keys(state.deck).length;
      const dueCount = deckDueList().length;

      $("#kpiDeck").textContent = total;

      if(!card){
        $("#flashFront").textContent = "—";
        $("#flashReading").textContent = "";
        $("#flashMeaning").textContent = "Adicione palavras ao deck na aba Vocabulário.";
        $("#deckStatus").textContent = `Deck vazio.`;
        return;
      }

      $("#flashFront").textContent = card.w;

      const vt = card.vt ? ` • ${vtLabel(card.vt)}` : "";
      $("#flashReading").textContent = (card.r || "") + vt;

      $("#flashMeaning").textContent = card.m || "";
      $("#deckStatus").textContent = `Cards: ${total} • Devidos agora: ${dueCount}`;
    }

    function rateCard(score){
      if(!currentCardKey || !state.deck[currentCardKey]) return;
      const c = state.deck[currentCardKey];
      const now = Date.now();
      c.seen = (c.seen||0) + 1;
      c.last = now;

      const base = 60 * 60 * 1000;
      let interval;
      if(score === 1){
        c.streak = 0;
        c.ease = clamp((c.ease||2.2) - 0.15, 1.3, 3.0);
        interval = base * 3;
      }else if(score === 2){
        c.streak = (c.streak||0) + 1;
        c.ease = clamp((c.ease||2.2) + 0.05, 1.3, 3.0);
        interval = base * 12 * (c.ease||2.2) * Math.max(1, c.streak/2);
      }else{
        c.streak = (c.streak||0) + 1;
        c.ease = clamp((c.ease||2.2) + 0.12, 1.3, 3.0);
        interval = base * 36 * (c.ease||2.2) * Math.max(1, c.streak/1.5);
      }
      c.due = now + interval;

      saveStateDebounced();
      renderDeckUI();
    }

    /***********************
     * QUIZ
     ***********************/
    function buildQuizItems(source, count){
      let pool = [];
      if(source === "DECK"){
        pool = Object.values(state.deck).map(x=>({ w:x.w, r:x.r, m:x.m, vt:x.vt||"" }));
      }else{
        const text = getTextById(state.activeTextId);
        if(text) pool = aggregateVocab(text).map(x=>({ w:x.w, r:x.r, m:x.m, vt:x.vt||"" }));
      }
      pool = pool.filter(x=>x.w && x.m);

      const uniq = new Map();
      for(const v of pool) uniq.set(wordKey(v), v);
      const arr = Array.from(uniq.values());
      shuffle(arr);
      return arr.slice(0, count);
    }

    function renderQuiz(){
      const wrap = $("#quizWrap");
      wrap.innerHTML = "";

      const src = $("#quizSource").value;
      const count = Number($("#quizCount").value);
      const items = buildQuizItems(src, count);

      if(items.length < 3){
        wrap.innerHTML = `<div class="muted" style="font-size:12px;margin-top:12px">Não há vocabulário suficiente para montar um quiz.</div>`;
        return;
      }

      const allMeanings = items.map(x=>x.m);

      items.forEach((it, idx)=>{
        const correct = it.m;
        const wrong = shuffle(allMeanings.filter(m=>m!==correct)).slice(0,3);
        const choices = shuffle([correct, ...wrong]);

        const vt = it.vt ? ` <span class="tag">${escapeHTML(vtLabel(it.vt))}</span>` : "";
        const el = document.createElement("div");
        el.className = "quizQ";
        el.innerHTML = `
          <h3>Q${idx+1}. O que significa <span style="font-family:var(--jp);font-weight:1000">${escapeHTML(it.w)}</span> (${escapeHTML(it.r||"")})? ${vt}</h3>
          <div class="choices">
            ${choices.map(c=>`
              <div class="choice" data-c="${escapeHTML(c)}" data-correct="${escapeHTML(correct)}">
                <div>${escapeHTML(c)}</div>
                <small>clique</small>
              </div>
            `).join("")}
          </div>
        `;
        wrap.appendChild(el);

        $$(".choice", el).forEach(ch=>{
          ch.addEventListener("click", ()=>{
            const picked = ch.getAttribute("data-c");
            const corr = ch.getAttribute("data-correct");
            $$(".choice", el).forEach(x=>x.style.pointerEvents="none");
            $$(".choice", el).forEach(x=>{
              const val = x.getAttribute("data-c");
              if(val === corr) x.classList.add("good");
              else if(val === picked) x.classList.add("bad");
            });
          });
        });
      });
    }

    /***********************
     * BOOKMARK / BULK OPEN
     ***********************/
    function toggleBookmark(){
      const text = getTextById(state.activeTextId);
      if(!text) return;
      const pr = ensureProgress(text.id);
      pr.bookmarked = !pr.bookmarked;
      saveStateDebounced();
      renderLibrary();
      renderMain();
      toast(pr.bookmarked ? "Favoritado ★" : "Removido ☆");
    }

    function expandAll(){
      $$(".lineCard", $("#lineList")).forEach(c=>c.classList.add("open"));
      $$(".lineCard", $("#focusLineList")).forEach(c=>c.classList.add("open"));
    }
    function collapseAll(){
      $$(".lineCard", $("#lineList")).forEach(c=>c.classList.remove("open"));
      $$(".lineCard", $("#focusLineList")).forEach(c=>c.classList.remove("open"));
    }

    function resetProgress(){
      if(!confirm("Resetar progresso (revisadas, favoritos e notas)? Deck e textos ficam.")) return;
      state.progress = {};
      saveStateNow();
      renderLibrary();
      renderMain();
      toast("Progresso resetado.");
    }

    /***********************
     * KPI
     ***********************/
    function refreshKPIs(){
      let doneTotal = 0;
      for(const tid of Object.keys(state.progress||{})){
        doneTotal += Object.keys(state.progress[tid].doneLines||{}).length;
      }
      $("#kpiLinesDone").textContent = doneTotal;
      $("#kpiDeck").textContent = Object.keys(state.deck||{}).length;
    }

    /***********************
     * TOAST
     ***********************/
    let toastTimer = null;
    function toast(msg){
      clearTimeout(toastTimer);
      let el = document.getElementById("toast");
      if(!el){
        el = document.createElement("div");
        el.id = "toast";
        el.style.position = "fixed";
        el.style.left = "50%";
        el.style.bottom = "18px";
        el.style.transform = "translateX(-50%)";
        el.style.padding = "10px 12px";
        el.style.borderRadius = "999px";
        el.style.border = "1px solid rgba(15,25,45,.18)";
        el.style.background = "rgba(255,255,255,.82)";
        el.style.backdropFilter = "blur(10px)";
        el.style.boxShadow = "0 18px 55px rgba(12,18,40,.12)";
        el.style.color = "rgba(14,22,48,.92)";
        el.style.fontSize = "12px";
        el.style.fontWeight = "1000";
        el.style.zIndex = "80";
        document.body.appendChild(el);
      }
      if(document.body.classList.contains("theme-dark")){
        el.style.border = "1px solid rgba(255,255,255,.18)";
        el.style.background = "rgba(0,0,0,.45)";
        el.style.boxShadow = "0 18px 55px rgba(0,0,0,.40)";
        el.style.color = "rgba(234,240,255,.92)";
      }else{
        el.style.border = "1px solid rgba(15,25,45,.18)";
        el.style.background = "rgba(255,255,255,.82)";
        el.style.boxShadow = "0 18px 55px rgba(12,18,40,.12)";
        el.style.color = "rgba(14,22,48,.92)";
      }

      el.textContent = msg;
      el.style.opacity = "1";
      toastTimer = setTimeout(()=>{ el.style.opacity = "0"; }, 1600);
    }

    /***********************
     * EVENTS + INIT
     ***********************/
    function bindEvents(){
      $$(".tab").forEach(t=> t.addEventListener("click", ()=> setTab(t.dataset.tab)));
      $("#searchInput").addEventListener("input", renderLibrary);

      $("#segN5").addEventListener("click", ()=> setLevelView("N5"));
      $("#segN4").addEventListener("click", ()=> setLevelView("N4"));

      $("#btnToggleFuri").addEventListener("click", toggleFurigana);
      $("#btnToggleFuri2").addEventListener("click", toggleFurigana);
      $("#btnToggleFuriFocus").addEventListener("click", toggleFurigana);

      $("#btnToggleReading").addEventListener("click", toggleReading);
      $("#btnToggleReading2").addEventListener("click", toggleReading);
      $("#btnToggleReadingFocus").addEventListener("click", toggleReading);

      $("#btnTogglePT").addEventListener("click", togglePT);
      $("#btnTogglePT2").addEventListener("click", togglePT);
      $("#btnTogglePTFocus").addEventListener("click", togglePT);

      $("#btnFontPlus").addEventListener("click", fontPlus);
      $("#btnFontPlus2").addEventListener("click", fontPlus);
      $("#btnFontPlusFocus").addEventListener("click", fontPlus);

      $("#btnFontMinus").addEventListener("click", fontMinus);
      $("#btnFontMinus2").addEventListener("click", fontMinus);
      $("#btnFontMinusFocus").addEventListener("click", fontMinus);

      $("#btnBookmark").addEventListener("click", toggleBookmark);
      $("#btnExpandAll").addEventListener("click", expandAll);
      $("#btnCollapseAll").addEventListener("click", collapseAll);

      $("#btnFocus").addEventListener("click", ()=> $("#focusOverlay").classList.add("open"));
      $("#btnExitFocus").addEventListener("click", ()=> $("#focusOverlay").classList.remove("open"));

      $("#btnTheme").addEventListener("click", toggleAppearance);

      $("#btnReveal").addEventListener("click", ()=> $("#flashCard").classList.toggle("revealed"));
      $("#btnNext").addEventListener("click", renderDeckUI);
      $("#btnRate1").addEventListener("click", ()=> rateCard(1));
      $("#btnRate2").addEventListener("click", ()=> rateCard(2));
      $("#btnRate3").addEventListener("click", ()=> rateCard(3));
      $("#btnClearDeck").addEventListener("click", ()=>{
        if(!confirm("Limpar todo o deck?")) return;
        state.deck = {};
        saveStateNow();
        renderDeckUI();
        refreshKPIs();
      });

      $("#btnNewQuiz").addEventListener("click", renderQuiz);

      $("#btnClearNotes").addEventListener("click", ()=>{
        const text = getTextById(state.activeTextId);
        if(!text) return;
        if(!confirm("Limpar as notas deste texto?")) return;
        ensureProgress(text.id).notes = "";
        saveStateNow();
        renderNotes(text);
        toast("Notas limpas.");
      });

      $("#btnReset").addEventListener("click", resetProgress);

      window.addEventListener("keydown", (e)=>{
        if(e.key === "Escape"){
          $("#focusOverlay").classList.remove("open");
        }
      });

      window.addEventListener("beforeunload", ()=> saveStateNow());
    }

    function init(){
      state.texts = state.texts || [];
      state.progress = state.progress || {};
      state.deck = state.deck || {};
      state.ui = mergeDeep({
        tab:"TAB_TEXT",
        showFurigana:true,
        showReading:true,
        showPT:true,
        fontScale:1,
        hue:210,
        levelView:"N5",
        appearance:"light"
      }, state.ui || {});

      applyAppearance();
      applyFontScale(state.ui.fontScale || 1);

      startTheme();
      bindEvents();

      setLevelView(state.ui.levelView || "N5");

      if(!state.activeTextId){
        const first = allTexts().find(t=>t.level === (state.ui.levelView||"N5"));
        state.activeTextId = first ? first.id : null;
        saveStateDebounced();
      }

      if(state.activeTextId) ensureProgress(state.activeTextId);

      renderLibrary();
      renderMain();
      refreshKPIs();
      syncToggleButtons();
    }

    init();
  </script>
</body>
</html>
